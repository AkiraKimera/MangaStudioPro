<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Studio AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4dFVxBKTJMasibMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #10111a;
            --bg-medium: #1a1a2e;
            --primary: #e94560;
            --primary-glow: rgba(233, 69, 96, 0.4);
            --secondary: #4a4a6a;
            --text-light: #f0f0f5;
            --text-medium: #a0a0b0;
            --border-color: rgba(255, 255, 255, 0.1);
            --transition-speed: 0.5s;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark); /* Fallback */
            background-image: 
                linear-gradient(rgba(16, 17, 26, 0.92), rgba(16, 17, 26, 0.98)),
                url('https://w.wallhaven.cc/full/zy/wallhaven-zygeko.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-light);
        }

        .tab-btn {
            position: relative;
            transition: color 0.3s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .tab-btn.active { color: white; }
        .tab-btn.active::after { width: 100%; }

        .glass-card {
            background: rgba(23, 23, 39, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #e94560 0%, #ff5e78 100%);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--primary-glow);
        }
        .btn-primary:disabled {
            background: #992d3e;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #6a6a8a;
            transform: translateY(-2px);
        }
        
        .form-input, .form-select, .form-textarea {
            background-color: #2a2a4a;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 0.75rem;
            padding: 0.75rem;
            transition: all 0.2s ease;
            width: 100%;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }
        .form-checkbox {
            appearance: none;
            background-color: #2a2a4a;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .form-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-glow);
        }


        .loader {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background: #ff5e78; }
        
        .page-canvas-display {
            background-color: white;
            display: grid;
            gap: 10px;
            padding: 10px;
            aspect-ratio: 2 / 3;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }
        #page-canvas.page-canvas-display:hover {
            transform: scale(1.02);
        }
        
        .story-page-wrapper .page-canvas-display:hover {
            transform: none;
        }
        .story-page-wrapper {
             width: calc(33.33% - 2rem);
             transition: width 0.3s ease;
        }


        .manga-panel {
            border: 2px solid #1a1a2e;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            background-color: #e0e0e0;
            border-radius: 4px;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }
        .manga-panel[draggable="true"]:hover {
            cursor: grab;
            transform: scale(1.05);
            border-color: var(--primary);
        }
        .manga-panel.drag-over {
             border-color: var(--primary);
             border-style: dashed;
             transform: scale(1.03);
        }


        .dialogue-bubble {
            position: absolute;
            /* bottom, left, transform, width are now set via inline styles */
            max-width: 95%;
            background-color: white;
            color: black;
            padding: 8px 12px;
            border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
            border: 2px solid black;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            /* font-size, line-height are now set via inline styles */
            line-height: 1.3;
            pointer-events: none; /* So it doesn't interfere with drag/drop */
        }
        .dialogue-bubble::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border-right: 2px solid black;
            border-bottom: 2px solid black;
            transform: rotate(45deg);
            bottom: -7px;
            left: 30%;
        }

        .dialogue-editor-wrapper {
            position: absolute;
            z-index: 10;
            cursor: move;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
        }
        .dialogue-editor {
            width: 100%;
            height: 100%;
            background-color: #ffffe0;
            color: black;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            resize: none;
            padding: 8px;
            border-radius: 6px;
        }
        .dialogue-editor:focus {
            outline: none;
        }

        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border: 2px solid white;
            border-radius: 50%;
            right: -8px;
            bottom: -8px;
            cursor: se-resize;
            z-index: 11;
        }
        .font-size-controls {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: var(--bg-medium);
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .font-size-btn {
            width: 24px;
            height: 24px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
        }
       
        .db-font {
            font-family: 'Bangers', cursive;
            letter-spacing: 2px;
            color: #F57C00;
            text-shadow: 
                1px 1px 0 #FFB300,
                -1px -1px 0 #E65100,
                3px 3px 0 #A62624,
                5px 5px 0 rgba(0,0,0,0.75),
                6px 6px 10px rgba(0,0,0,0.5);
        }
        .db-font-ai {
            color: #D32F2F;
            text-shadow: 
                1px 1px 0 #FF5252,
                -1px -1px 0 #B71C1C,
                3px 3px 0 #4E342E,
                5px 5px 0 rgba(0,0,0,0.75),
                6px 6px 10px rgba(0,0,0,0.5);
        }


        #animation-preview-container {
            position: relative;
            overflow: hidden;
        }
        #animation-preview-container img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
            transition: opacity var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
        }
        .anim-img-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .anim-img-visible {
            opacity: 1;
        }
        .fade-out { opacity: 0 !important; }
        .fade-in { opacity: 1 !important; }
        .slide-out { transform: translateX(-100%); opacity: 0; }
        .slide-in { transform: translateX(0); opacity: 1; }
        .slide-in-initial { transform: translateX(100%); opacity: 0; }
    </style>
    <style id="dynamic-story-styles"></style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="relative text-center mb-10">
            <button id="music-toggle-btn" class="absolute top-0 right-0 p-2 text-text-medium hover:text-white transition-colors">
                <svg id="music-icon-on" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
                <svg id="music-icon-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l-4-4m0 4l4-4" />
                </svg>
            </button>
            <div class="flex items-center justify-center gap-4">
                <svg class="w-16 h-16" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-labelledby="dragonball-title" role="img" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6));">
                    <title id="dragonball-title">Esfera del Dragón de Cuatro Estrellas</title>
                    <defs>
                        <radialGradient id="ballGradient" cx="30%" cy="30%" r="70%" fx="35%" fy="35%">
                            <stop offset="0%" stop-color="#FFD180" />
                            <stop offset="50%" stop-color="#FFAB40" />
                            <stop offset="100%" stop-color="#E65100" />
                        </radialGradient>
                        <g id="star">
                             <path d="M10 0 L7.76 6.9 H0 L6.18 11.18 L3.92 18.09 L10 13.82 L16.08 18.09 L13.82 11.18 L20 6.9 H12.24 Z" fill="#D50000" stroke="#8E0000" stroke-width="1.2" />
                        </g>
                    </defs>
                    <circle cx="50" cy="50" r="48" fill="url(#ballGradient)" stroke="#4E342E" stroke-width="2.5" />
                    <path d="M 30 20 A 40 40 0 0 1 75 25 A 55 55 0 0 1 65 75 A 40 30 0 0 0 25 30 Z" fill="white" fill-opacity="0.3" />
                    <g transform="translate(50 50) scale(1.4)">
                        <use href="#star" transform="translate(-10 -20)" />
                        <use href="#star" transform="translate(-20 -5)" />
                        <use href="#star" transform="translate(0 -5)" />
                        <use href="#star" transform="translate(-10, 10)" />
                    </g>
                </svg>
                <h1 class="text-5xl md:text-6xl font-bold db-font">
                    Manga Studio <span class="db-font-ai">AI</span>
                </h1>
                <span class="text-sm font-semibold align-top bg-yellow-400 text-black rounded-full px-3 py-1 shadow-lg animate-pulse">PRO</span>
            </div>
            <p class="text-lg text-text-medium mt-2">Tu estudio creativo para dar vida a tus historias</p>
        </header>

        <nav class="flex flex-wrap justify-center mb-10 border-b border-border-color">
            <button data-tab="page" class="tab-btn active text-lg font-semibold py-4 px-6 text-text-medium">Generador</button>
            <button data-tab="story" class="tab-btn text-lg font-semibold py-4 px-6 text-text-medium">Historia</button>
            <button data-tab="animation" class="tab-btn text-lg font-semibold py-4 px-6 text-text-medium">Animación</button>
        </nav>

        <main>
            <div id="page-panel" data-panel="page">
                <div class="glass-card p-6 md:p-8">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-3xl font-bold mb-2 text-white text-center">Creador de Páginas</h2>
                        <p class="text-center text-text-medium mb-8">Construye tu escena con detalles para obtener el mejor resultado.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block mb-2 text-md font-semibold text-text-light">Guía del Protagonista (Opcional)</label>
                                <div id="guide-image-dropzone" class="relative flex flex-col items-center justify-center w-full h-40 border-2 border-border-color border-dashed rounded-xl cursor-pointer bg-black/20 hover:bg-black/30">
                                    <div id="guide-image-placeholder" class="absolute flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                        <svg class="w-8 h-8 mb-4 text-text-medium" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                        <p class="mb-2 text-sm text-text-medium"><span class="font-semibold">Sube una imagen de tu personaje</span></p>
                                    </div>
                                    <img id="guide-image-preview" class="hidden w-full h-full object-contain rounded-lg p-2" />
                                    <button id="remove-guide-image-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-sm">&times;</button>
                                    <input id="guide-image-upload" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" />
                                </div>
                            </div>
                            <div>
                                <label class="block mb-2 text-md font-semibold text-text-light">Complemento de Guía (Opcional)</label>
                                <div id="guide-complement-dropzone" class="relative flex flex-col items-center justify-center w-full h-40 border-2 border-border-color border-dashed rounded-xl cursor-pointer bg-black/20 hover:bg-black/30">
                                    <div id="guide-complement-placeholder" class="absolute flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                        <svg class="w-8 h-8 mb-4 text-text-medium" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                        <p class="mb-2 text-sm text-text-medium"><span class="font-semibold">Sube un coche, accesorio, etc.</span></p>
                                    </div>
                                    <img id="guide-complement-preview" class="hidden w-full h-full object-contain rounded-lg p-2" />
                                    <button id="remove-guide-complement-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-sm">&times;</button>
                                    <input id="guide-complement-upload" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" />
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="prompt-characters" class="block mb-2 text-md font-semibold text-text-light">1. Personajes en la Escena</label>
                                <textarea id="prompt-characters" rows="3" class="form-textarea" placeholder="Ej: El personaje de la 'imagen guia' y su rival, un guerrero veterano con una cicatriz."></textarea>
                            </div>
                            <div>
                                <label for="prompt-setting" class="block mb-2 text-md font-semibold text-text-light">2. Lugar y Ambiente</label>
                                <textarea id="prompt-setting" rows="3" class="form-textarea" placeholder="Ej: En un bosque oscuro, junto al coche del 'complemento guia'."></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="prompt-action" class="block mb-2 text-md font-semibold text-text-light">3. Acción Principal de la Página</label>
                                <textarea id="prompt-action" rows="4" class="form-textarea" placeholder="Ej: El guerrero protege a la maga de un ataque sorpresa. Ella prepara un hechizo de luz mientras él levanta su escudo. Hay un sentimiento de urgencia."></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div>
                                <label for="full-page-style" class="block mb-2 text-sm font-medium text-text-light">Estilo Visual</label>
                                <select id="full-page-style" class="form-select">
                                    <option value="estilo manga clasico en blanco y negro, alto detalle, sombreado de trama">Manga Clásico (B/N)</option>
                                    <option value="estilo anime moderno, colores vibrantes, iluminacion cinematografica">Anime Moderno (Color)</option>
                                    <option value="estilo inspirado en Studio Ghibli, fondos pintorescos de acuarela, personajes encantadores">Estilo Ghibli</option>
                                    <option value="estilo anime Shonen de los 90, accion dinamica, lineas fuertes, aspecto retro">Anime Shōnen (90s)</option>
                                    <option value="estilo Isekai, mundo de fantasia vibrante, elementos magicos, armaduras detalladas">Anime Isekai</option>
                                    <option value="estilo Slice of Life, colores calidos y suaves, escenas cotidianas, fondos urbanos o escolares">Anime Slice of Life</option>
                                    <option value="estilo fantasia historica, arquitectura de epoca, vestimenta detallada, atmosfera epica">Fantasía Histórica</option>
                                </select>
                            </div>
                            <div>
                                <label for="full-page-tone" class="block mb-2 text-sm font-medium text-text-light">Tono Narrativo</label>
                                <select id="full-page-tone" class="form-select">
                                    <option value="">Automático</option>
                                    <option value="con un tono dramatico y serio">Dramático</option>
                                    <option value="con un tono de comedia y humor">Comedia</option>
                                    <option value="con un tono de accion y ritmo rapido">Acción</option>
                                    <option value="con un tono de misterio e intriga">Misterio</option>
                                    <option value="con un tono romantico y emotivo">Romance</option>
                                </select>
                            </div>
                            <div>
                                <label for="full-page-arc" class="block mb-2 text-sm font-medium text-text-light">Punto de la Historia</label>
                                <select id="full-page-arc" class="form-select">
                                    <option value="">Automático</option>
                                    <option value="el principio (presentacion de personajes/conflicto)">Principio</option>
                                    <option value="el nudo (desarrollo, punto de inflexion)">Nudo (Desarrollo)</option>
                                    <option value="el desenlace (conclusion, climax final)">Desenlace (Final)</option>
                                </select>
                            </div>
                        </div>

                        <div class="glass-card p-4 my-6 border border-sky-400/30">
                            <h4 class="text-lg font-semibold mb-4 text-center text-sky-300">Potenciadores de Calidad (Opcional)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="prompt-negative" class="block mb-2 text-sm font-medium text-text-light">Prompt Negativo</label>
                                    <textarea id="prompt-negative" rows="3" class="form-textarea text-sm" placeholder="Ej: manos deformes, mala anatomía, texto, firmas, borroso..."></textarea>
                                </div>
                                <div class="flex flex-col justify-center items-start pt-4">
                                     <label for="quality-booster" class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="quality-booster" class="form-checkbox">
                                        <span class="ml-3 text-text-light">Activar Potenciador Mágico</span>
                                    </label>
                                    <p class="text-xs text-text-medium mt-2 ml-3">Añade automáticamente términos como "obra maestra, alta resolución, ultra detallado..." para mejorar la calidad.</p>
                                </div>
                            </div>
                        </div>

                        <button id="generate-full-page-btn" class="btn btn-primary w-full text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            ¡Crear Página Mágica!
                        </button>

                        <div id="page-loader" class="hidden flex-col items-center mt-8">
                            <div class="loader"></div>
                            <p id="page-loader-text" class="mt-4 text-text-medium">Creando tu página...</p>
                        </div>
                        
                        <div id="page-result-area" class="mt-8">
                            <div id="page-canvas" class="page-canvas-display">
                                <div class="manga-panel flex items-center justify-center text-center text-text-medium p-4">
                                    <p>Tu página de manga aparecerá aquí.</p>
                                </div>
                            </div>
                            <div id="page-actions-wrapper" class="hidden flex-wrap items-center justify-center gap-4 mt-6">
                                <button id="add-to-story-btn" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
                                    Añadir a la Historia
                                </button>
                                <button id="continue-story-btn" class="btn btn-primary">
                                    Continuar Historia 
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="story-panel" data-panel="story" class="hidden">
                <div class="glass-card p-6 md:p-8">
                     <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">Editor de Historia</h2>
                            <p class="text-text-medium">Arrastra y suelta viñetas para reorganizar tu manga.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label for="zoom-slider" class="text-sm font-semibold">Zoom:</label>
                                <input type="range" id="zoom-slider" min="20" max="45" value="31" class="w-32">
                            </div>
                            <button id="add-blank-page-btn" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                Página en Blanco
                            </button>
                        </div>
                    </div>
                    <div id="story-board-container" class="flex flex-wrap justify-center gap-8">
                        <div id="story-placeholder" class="col-span-full text-center text-text-medium p-10 border-2 border-dashed border-border-color rounded-lg">
                            <p class="text-lg">Tu historia está en blanco.</p>
                            <p>Ve al "Generador" para empezar a crear y añadir tus páginas aquí.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="animation-panel" data-panel="animation" class="hidden">
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-3xl font-bold mb-2 text-white text-center">Estudio de Animación</h2>
                    <p class="text-center text-text-medium mb-8">Crea animaciones sencillas con tus imágenes.</p>

                    <div class="text-center mb-6 bg-yellow-900/50 border border-yellow-700 p-3 rounded-xl">
                        <p><strong>Nota:</strong> Guarda páginas en tu <span class="font-bold">Historia</span> para poder añadirlas a la animación.</p>
                    </div>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h3 class="font-semibold mb-3 text-lg">Paneles / Frames</h3>
                            <div id="animation-frames" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-3 gap-2 p-2 bg-black/20 rounded-xl min-h-[100px] max-h-96 overflow-y-auto">
                                <p id="frames-placeholder" class="col-span-full text-center text-text-medium p-4">Añade páginas desde la pestaña Historia.</p>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div id="animation-preview-container" class="aspect-[2/3] max-w-[350px] mx-auto bg-black rounded-lg flex items-center justify-center border-2 border-border-color overflow-hidden">
                                <img id="anim-img-1" class="anim-img-hidden" alt="Frame de animación 1">
                                <img id="anim-img-2" class="anim-img-hidden" alt="Frame de animación 2">
                            </div>
                            <div class="mt-4 flex flex-col md:flex-row items-center justify-center flex-wrap gap-4">
                                <button id="play-pause-btn" class="btn btn-primary py-2 px-6 text-lg">▶ Play</button>
                                <div class="flex items-center gap-2">
                                    <label for="fps-slider">Velocidad (FPS):</label>
                                    <input type="range" id="fps-slider" min="1" max="24" value="5" class="w-24">
                                    <span id="fps-value" class="font-mono">5</span>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <label for="transition-select">Transición:</label>
                                    <select id="transition-select" class="form-select !w-auto !py-1 !px-2 !text-sm">
                                        <option value="none">Ninguna</option>
                                        <option value="fade">Fundido</option>
                                        <option value="slide">Deslizar</option>
                                    </select>
                                </div>
                                <button id="clear-animation-btn" class="btn bg-red-600 hover:bg-red-700">Limpiar</button>
                                <button id="download-animation-btn" class="btn btn-secondary w-full md:w-auto mt-2 md:mt-0">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Descargar Animación (GIF)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
        
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-red-500 rounded-lg p-6 max-w-sm w-full text-center shadow-lg">
            <h3 class="text-xl font-bold text-red-500 mb-2">Error</h3>
            <p id="error-message" class="text-gray-300 mb-4"></p>
            <button id="close-error-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded">Cerrar</button>
        </div>
    </div>
    
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg z-50">
        <p id="toast-message"></p>
    </div>
    
    <div id="download-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-green-500 rounded-lg p-6 max-w-sm w-full text-center shadow-lg">
            <h3 class="text-xl font-bold text-green-400 mb-2">Archivo Listo</h3>
            <p class="text-gray-300 mb-4">Tu archivo está listo para ser descargado.</p>
            <div id="download-modal-content" class="my-4"></div>
            <button id="close-download-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancelar</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const App = {
            state: {
                activeTab: 'page',
                animationFrames: [],
                storyPages: [],
                isPlaying: false,
                isMusicPlaying: false,
                audioPlayer: null,
                animationInterval: null,
                fps: 5,
                guideImage: null,
                guideComplementImage: null,
                lastGeneratedScript: null,
                lastGeneratedLayout: null,
                draggedPanelInfo: null,
                useGuideImageForCurrentStory: false,
                useGuideComplementForCurrentStory: false,
                currentTransition: 'fade',
                activeAnimImage: null,
            },
           
            dom: {},

            init() {
                this.cacheDom();
                this.bindEvents();
                this.render();
            },

            cacheDom() {
                this.dom.musicToggleBtn = document.getElementById('music-toggle-btn');
                this.dom.musicIconOn = document.getElementById('music-icon-on');
                this.dom.musicIconOff = document.getElementById('music-icon-off');
                this.dom.addBlankPageBtn = document.getElementById('add-blank-page-btn');
                this.dom.zoomSlider = document.getElementById('zoom-slider');
                this.dom.dynamicStoryStyles = document.getElementById('dynamic-story-styles');

                this.dom.tabButtons = document.querySelectorAll('.tab-btn');
                this.dom.panels = document.querySelectorAll('[data-panel]');
                this.dom.guideImageUpload = document.getElementById('guide-image-upload');
                this.dom.guideImagePreview = document.getElementById('guide-image-preview');
                this.dom.guideImagePlaceholder = document.getElementById('guide-image-placeholder');
                this.dom.removeGuideImageBtn = document.getElementById('remove-guide-image-btn');
                this.dom.guideComplementUpload = document.getElementById('guide-complement-upload');
                this.dom.guideComplementPreview = document.getElementById('guide-complement-preview');
                this.dom.guideComplementPlaceholder = document.getElementById('guide-complement-placeholder');
                this.dom.removeGuideComplementBtn = document.getElementById('remove-guide-complement-btn');
                this.dom.promptCharacters = document.getElementById('prompt-characters');
                this.dom.promptSetting = document.getElementById('prompt-setting');
                this.dom.promptAction = document.getElementById('prompt-action');
                this.dom.fullPageStyle = document.getElementById('full-page-style');
                this.dom.fullPageTone = document.getElementById('full-page-tone');
                this.dom.fullPageArc = document.getElementById('full-page-arc');
                this.dom.generateBtn = document.getElementById('generate-full-page-btn');
                this.dom.continueBtn = document.getElementById('continue-story-btn');
                this.dom.addToStoryBtn = document.getElementById('add-to-story-btn');
                this.dom.pageLoader = document.getElementById('page-loader');
                this.dom.pageLoaderText = document.getElementById('page-loader-text');
                this.dom.pageCanvas = document.getElementById('page-canvas');
                this.dom.pageActionsWrapper = document.getElementById('page-actions-wrapper');
                this.dom.promptNegative = document.getElementById('prompt-negative');
                this.dom.qualityBooster = document.getElementById('quality-booster');
                this.dom.storyBoardContainer = document.getElementById('story-board-container');
                this.dom.storyPlaceholder = document.getElementById('story-placeholder');
                this.dom.animationFramesContainer = document.getElementById('animation-frames');
                this.dom.framesPlaceholder = document.getElementById('frames-placeholder');
                this.dom.animImg1 = document.getElementById('anim-img-1');
                this.dom.animImg2 = document.getElementById('anim-img-2');
                this.dom.playPauseBtn = document.getElementById('play-pause-btn');
                this.dom.fpsSlider = document.getElementById('fps-slider');
                this.dom.fpsValue = document.getElementById('fps-value');
                this.dom.clearAnimationBtn = document.getElementById('clear-animation-btn');
                this.dom.transitionSelect = document.getElementById('transition-select');
                this.dom.downloadAnimationBtn = document.getElementById('download-animation-btn');
                this.dom.errorModal = document.getElementById('error-modal');
                this.dom.errorMessage = document.getElementById('error-message');
                this.dom.closeErrorModalBtn = document.getElementById('close-error-modal-btn');
                this.dom.toast = document.getElementById('toast-notification');
                this.dom.toastMessage = document.getElementById('toast-message');
                this.dom.downloadModal = document.getElementById('download-modal');
                this.dom.downloadModalContent = document.getElementById('download-modal-content');
                this.dom.closeDownloadModalBtn = document.getElementById('close-download-modal-btn');
            },

            bindEvents() {
                this.dom.musicToggleBtn.addEventListener('click', () => this.handlers.toggleMusic());
                this.dom.addBlankPageBtn.addEventListener('click', () => this.flows.addBlankPage());
                this.dom.zoomSlider.addEventListener('input', (e) => this.handlers.handleZoomChange(e));
                this.dom.tabButtons.forEach(btn => btn.addEventListener('click', () => this.ui.switchTab(btn.dataset.tab)));
                this.dom.generateBtn.addEventListener('click', () => this.flows.generateFullPage());
                this.dom.continueBtn.addEventListener('click', () => this.flows.continueStory());
                this.dom.addToStoryBtn.addEventListener('click', () => this.flows.addPageToStory());
                this.dom.guideImageUpload.addEventListener('change', (e) => this.handlers.handleGuideImageUpload(e, 'guideImage'));
                this.dom.removeGuideImageBtn.addEventListener('click', (e) => this.handlers.handleRemoveGuideImage(e, 'guideImage'));
                this.dom.guideComplementUpload.addEventListener('change', (e) => this.handlers.handleGuideImageUpload(e, 'guideComplementImage'));
                this.dom.removeGuideComplementBtn.addEventListener('click', (e) => this.handlers.handleRemoveGuideImage(e, 'guideComplementImage'));
                this.dom.playPauseBtn.addEventListener('click', () => this.animation.toggle());
                this.dom.clearAnimationBtn.addEventListener('click', () => this.animation.clear());
                this.dom.fpsSlider.addEventListener('input', (e) => this.animation.setFps(e.target.value));
                this.dom.transitionSelect.addEventListener('change', (e) => this.animation.setTransition(e.target.value));
                this.dom.downloadAnimationBtn.addEventListener('click', () => this.animation.download());
                this.dom.closeErrorModalBtn.addEventListener('click', () => this.ui.showErrorModal(null));
                this.dom.closeDownloadModalBtn.addEventListener('click', () => this.ui.showDownloadModal(null));
                
                // Event delegation for story board
                const storyBoard = this.dom.storyBoardContainer;
                storyBoard.addEventListener('dragstart', (e) => this.handlers.handleDragStart(e));
                storyBoard.addEventListener('dragover', (e) => this.handlers.handleDragOver(e));
                storyBoard.addEventListener('dragleave', (e) => this.handlers.handleDragLeave(e));
                storyBoard.addEventListener('drop', (e) => this.handlers.handleDrop(e));
                storyBoard.addEventListener('click', (e) => this.handlers.handleStoryBoardClick(e));
                storyBoard.addEventListener('dblclick', (e) => this.handlers.handleStoryBoardDblClick(e));
            },
            
            render() {
                this.ui.updateTabUI();
                this.ui.updateStoryEditorUI();
                this.ui.updateAnimationFramesUI();
                this.handlers.handleZoomChange({ target: this.dom.zoomSlider }); // Apply initial zoom
            },
            
            ui: {
                switchTab(tabName) { App.state.activeTab = tabName; App.render(); },
                updateTabUI() { App.dom.panels.forEach(p => p.classList.toggle('hidden', p.dataset.panel !== App.state.activeTab)); App.dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === App.state.activeTab)); },
                showErrorModal(message) { if (message) { App.dom.errorMessage.textContent = message; App.dom.errorModal.classList.remove('hidden'); } else { App.dom.errorModal.classList.add('hidden'); } },
                showDownloadModal(linkElement) {
                    const { downloadModal, downloadModalContent } = App.dom;
                    if (linkElement) {
                        downloadModalContent.innerHTML = '';
                        downloadModalContent.appendChild(linkElement);
                        downloadModal.classList.remove('hidden');
                    } else {
                        downloadModal.classList.add('hidden');
                        const oldLink = downloadModalContent.querySelector('a');
                        if (oldLink && oldLink.href.startsWith('blob:')) { URL.revokeObjectURL(oldLink.href); }
                    }
                },
                showToast(message) { App.dom.toastMessage.textContent = message; App.dom.toast.classList.remove('hidden'); setTimeout(() => App.dom.toast.classList.add('hidden'), 3000); },
                setPageLoading(isLoading, text = '') { App.dom.generateBtn.disabled = isLoading; App.dom.continueBtn.disabled = isLoading; App.dom.downloadAnimationBtn.disabled = isLoading; App.dom.pageLoader.classList.toggle('hidden', !isLoading); App.dom.pageLoader.classList.toggle('flex', isLoading); App.dom.pageLoaderText.textContent = text; },
                renderPage(container, pageData) {
                    container.innerHTML = '';
                    container.className = `page-canvas-display ${pageData.layout.grid}`;
                    pageData.panels.forEach((panelData, index) => {
                        const panel = document.createElement('div');
                        panel.className = `manga-panel ${pageData.layout.panels[index] || ''}`;
                        panel.dataset.pageId = pageData.id;
                        panel.dataset.panelId = panelData.id;
                        panel.draggable = true;

                        if (panelData.imageUrl) {
                            panel.style.backgroundImage = `url(${panelData.imageUrl})`;
                        } else if (panelData.error) {
                             const errorMsg = panelData.error.includes('PROHIBITED_CONTENT') ? "Bloqueado por seguridad. Prueba una descripción diferente." : "Error al generar imagen.";
                             panel.innerHTML = `<div class="flex items-center justify-center h-full text-xs text-center text-red-500 bg-red-100 p-1">${errorMsg}</div>`;
                        }
                        if (panelData.dialogue) {
                            const bubble = document.createElement('div');
                            bubble.className = 'dialogue-bubble';
                            bubble.textContent = panelData.dialogue;
                            // Apply custom styles if they exist
                            if (panelData.dialogueConfig) {
                                const { top, left, width, height, fontSize } = panelData.dialogueConfig;
                                bubble.style.top = `${top}%`;
                                bubble.style.left = `${left}%`;
                                bubble.style.width = `${width}px`;
                                bubble.style.height = `${height}px`;
                                bubble.style.fontSize = `${fontSize}px`;
                                bubble.style.transform = 'translate(-50%, -50%)'; // Use a more accurate transform for centered positioning
                            } else {
                                // Default styles for bubbles without custom config
                                bubble.style.bottom = '8%';
                                bubble.style.left = '50%';
                                bubble.style.width = '85%';
                                bubble.style.transform = 'translateX(-50%)';
                            }
                            panel.appendChild(bubble);
                        }
                        container.appendChild(panel);
                    });
                },
                renderGeneratedPage(panelData) {
                    const layout = App.flows.getLayoutForPanels(panelData.length);
                    App.state.lastGeneratedLayout = layout; // Save layout for storing
                    App.state.lastGeneratedScript = panelData; // Save the final panel data with images
                    
                    const pageData = {
                        id: 'generator-canvas',
                        layout: layout,
                        panels: panelData.map((p, i) => ({...p, id: `gen-panel-${i}`}))
                    };
                    this.renderPage(App.dom.pageCanvas, pageData);
                },
                updateStoryEditorUI() {
                    const { storyBoardContainer, storyPlaceholder } = App.dom;
                    storyBoardContainer.innerHTML = '';
                    if (App.state.storyPages.length === 0) {
                        storyBoardContainer.appendChild(storyPlaceholder);
                    } else {
                        App.state.storyPages.forEach((pageData, pageIndex) => {
                            const pageWrapper = document.createElement('div');
                            pageWrapper.className = 'story-page-wrapper';
                            
                            const pageHeader = document.createElement('div');
                            pageHeader.className = 'flex justify-between items-center mb-2';
                            pageHeader.innerHTML = `
                                <div class="bg-black/70 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">${pageIndex + 1}</div>
                                <div class="flex gap-2">
                                    <button data-action="add-to-animation" data-page-id="${pageData.id}" class="btn btn-secondary !p-2" title="Añadir a Animación">&#x2728;</button>
                                    <button data-action="download" data-page-id="${pageData.id}" class="btn btn-primary !p-2" title="Descargar Página">&#x21E9;</button>
                                    <button data-action="delete" data-page-id="${pageData.id}" class="bg-red-600 hover:bg-red-700 text-white btn !p-2" title="Eliminar Página">&#x1F5D1;</button>
                                </div>
                            `;
                            
                            const pageCanvas = document.createElement('div');
                            this.renderPage(pageCanvas, pageData);
                            
                            pageWrapper.appendChild(pageHeader);
                            pageWrapper.appendChild(pageCanvas);
                            storyBoardContainer.appendChild(pageWrapper);
                        });
                    }
                },
                updateAnimationFramesUI() {
                     const { animationFramesContainer, framesPlaceholder, animImg1, animImg2 } = App.dom;
                    animationFramesContainer.innerHTML = '';
                    if (App.state.animationFrames.length === 0) {
                        framesPlaceholder.classList.remove('hidden');
                        animImg1.classList.add('anim-img-hidden'); animImg2.classList.add('anim-img-hidden');
                        animImg1.src = ''; animImg2.src = '';
                    } else {
                        framesPlaceholder.classList.add('hidden');
                        App.state.animationFrames.forEach(src => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'aspect-video flex items-center justify-center bg-black/20 rounded-lg p-1';
                            wrapper.innerHTML = `<img src="${src}" class="w-full h-auto object-contain rounded-md">`;
                            animationFramesContainer.appendChild(wrapper);
                        });
                        if (!animImg1.src) { animImg1.src = App.state.animationFrames[0]; animImg1.classList.remove('anim-img-hidden'); App.state.activeAnimImage = animImg1; }
                    }
                }
            },

            api: {
                async callApi(endpoint, payload) {
                     const response = await fetch(`/.netlify/functions/${endpoint}`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Error from server: ${response.status} - ${errorBody}`);
                    }
                    return response.json();
                }
            },

            flows: {
                getLayoutForPanels(panelCount) {
                     const layouts = { 1: { grid: 'grid-cols-1 grid-rows-1', panels: ['col-span-1 row-span-1'] }, 2: [{ grid: 'grid-cols-1 grid-rows-2', panels: ['row-span-1', 'row-span-1'] }, { grid: 'grid-cols-2 grid-rows-1', panels: ['col-span-1', 'col-span-1'] }], 3: [{ grid: 'grid-cols-2 grid-rows-2', panels: ['col-span-2 row-span-1', 'col-span-1 row-span-1', 'col-span-1 row-span-1'] }, { grid: 'grid-cols-2 grid-rows-2', panels: ['col-span-1 row-span-2', 'col-span-1 row-span-1', 'col-span-1 row-span-1'] }], 4: [{ grid: 'grid-cols-2 grid-rows-2', panels: ['col-span-1', 'col-span-1', 'col-span-1', 'col-span-1'] }, { grid: 'grid-cols-2 grid-rows-3', panels: ['col-span-2 row-span-1', 'col-span-1 row-span-2', 'col-span-1 row-span-2'] }] };
                    if (!layouts[panelCount]) return { grid: 'grid-cols-1', panels: [] };
                    return Array.isArray(layouts[panelCount]) ? layouts[panelCount][Math.floor(Math.random() * layouts[panelCount].length)] : layouts[panelCount];
                },
                addBlankPage() {
                    const blankPageData = {
                        id: `page-${Date.now()}`,
                        layout: this.getLayoutForPanels(4),
                        panels: Array(4).fill(null).map((_, i) => ({
                            id: `blank-${Date.now()}-${i}`,
                            imageUrl: null,
                            dialogue: '',
                            description: 'Panel en blanco'
                        }))
                    };
                    App.state.storyPages.push(blankPageData);
                    App.render();
                    App.ui.showToast('Página en blanco añadida.');
                },
                async runGenerationProcess(prompt, tone, arc, useGuideImage, useGuideComplement) {
                    if (App.dom.generateBtn.disabled) return;
                    
                    App.ui.setPageLoading(true, "Creando el guion...");
                    App.dom.pageCanvas.innerHTML = '';
                    App.dom.pageActionsWrapper.classList.add('hidden');
                    try {
                        const scriptPayload = { type: 'script', prompt, tone, arc };
                        const script = await App.api.callApi('generate', scriptPayload);

                        if (!script || !Array.isArray(script) || script.length === 0) { throw new Error("La IA no devolvió un guion válido. Intenta reformular tu idea."); }
                        
                        const maxAttempts = 4;
                        let panelData = script.map(panel => ({ ...panel, imageUrl: null, error: null }));
                        let failedPanelIndexes = panelData.map((_, index) => index);
                        
                        for (let attempt = 1; attempt <= maxAttempts && failedPanelIndexes.length > 0; attempt++) {
                            App.ui.setPageLoading(true, `Generando ${failedPanelIndexes.length} imágenes (intento ${attempt}/${maxAttempts})...`);
                            
                            const promisesForFailed = failedPanelIndexes.map(index => {
                                const panel = panelData[index];
                                const imagePayload = {
                                    type: 'image',
                                    description: panel.description,
                                    useGuideImage: useGuideImage,
                                    guideImage: App.state.guideImage,
                                    useGuideComplement: useGuideComplement,
                                    guideComplementImage: App.state.guideComplementImage,
                                    style: App.dom.fullPageStyle.value,
                                    negativePrompt: App.dom.promptNegative.value.trim(),
                                    useBooster: App.dom.qualityBooster.checked
                                };
                                return App.api.callApi('generate', imagePayload);
                            });

                            const results = await Promise.allSettled(promisesForFailed);
                            const stillFailingIndexes = [];
                            results.forEach((result, i) => {
                                const originalPanelIndex = failedPanelIndexes[i];
                                if (result.status === 'fulfilled' && result.value.imageUrl) { 
                                    panelData[originalPanelIndex].imageUrl = result.value.imageUrl; 
                                    panelData[originalPanelIndex].error = null; 
                                } else { 
                                    panelData[originalPanelIndex].error = result.reason?.message || result.value?.error || 'Unknown error'; 
                                    stillFailingIndexes.push(originalPanelIndex); 
                                }
                            });
                            failedPanelIndexes = stillFailingIndexes;
                        }
                        
                        App.state.lastGeneratedScript = panelData; 
                        
                        App.ui.setPageLoading(true, "Componiendo la página final...");
                        App.ui.renderGeneratedPage(panelData);
                        App.dom.pageActionsWrapper.classList.remove('hidden');
                    } catch (error) {
                        console.error("Error detallado en el proceso de generación:", error);
                        App.ui.showErrorModal(`Ocurrió un error en la creación: ${error.message}`);
                        App.dom.pageCanvas.innerHTML = '<div class="manga-panel flex items-center justify-center text-center text-gray-500 p-4"><p>La generación falló. Inténtalo de nuevo.</p></div>';
                    } finally { App.ui.setPageLoading(false); }
                },
                generateFullPage() {
                    const characters = App.dom.promptCharacters.value.trim();
                    const setting = App.dom.promptSetting.value.trim();
                    const action = App.dom.promptAction.value.trim();
                    if (!action) { App.ui.showErrorModal("Por favor, describe la 'Acción Principal de la Página'."); return; }
                    const combinedPrompt = `Personajes: ${characters || 'No especificados'}. Lugar: ${setting || 'No especificado'}. Acción de la página: ${action}.`;
                    App.state.lastPrompt = combinedPrompt;
                    const fullPromptText = `${characters} ${setting} ${action}`.toLowerCase();
                    App.state.useGuideImageForCurrentStory = App.state.guideImage && fullPromptText.includes('imagen guia');
                    App.state.useGuideComplementForCurrentStory = App.state.guideComplementImage && fullPromptText.includes('complemento guia');
                    const tone = App.dom.fullPageTone.value;
                    const arc = App.dom.fullPageArc.value;
                    this.runGenerationProcess(combinedPrompt, tone, arc, App.state.useGuideImageForCurrentStory, App.state.useGuideComplementForCurrentStory);
                },
                continueStory() {
                    if (!App.state.lastGeneratedScript || App.state.lastGeneratedScript.length === 0) { App.ui.showErrorModal("Primero debes generar una página para poder continuar la historia."); return; }
                    const lastPanel = App.state.lastGeneratedScript[App.state.lastGeneratedScript.length - 1];
                    const lastSceneSummary = `La última viñeta mostraba: ${lastPanel.description.trim()} ${lastPanel.dialogue ? `(con el diálogo: "${lastPanel.dialogue.trim()}")` : ''}`;
                    const continuationPrompt = `La historia principal es sobre: "${App.state.lastPrompt}". ${lastSceneSummary}. Continúa la historia a partir de este punto, generando las siguientes 3 o 4 viñetas.`;
                    const tone = App.dom.fullPageTone.value;
                    this.runGenerationProcess(continuationPrompt, tone, "el nudo (desarrollo, punto de inflexion)", App.state.useGuideImageForCurrentStory, App.state.useGuideComplementForCurrentStory);
                },
                addPageToStory() {
                    if (!App.state.lastGeneratedScript || !App.state.lastGeneratedLayout) {
                        App.ui.showErrorModal("No hay una página generada para añadir a la historia.");
                        return;
                    }
                     const newPageData = {
                        id: `page-${Date.now()}`,
                        layout: App.state.lastGeneratedLayout,
                        panels: App.state.lastGeneratedScript.map((panel, index) => ({
                            id: `panel-${Date.now()}-${index}`,
                            imageUrl: panel.imageUrl,
                            dialogue: panel.dialogue,
                            description: panel.description,
                            error: panel.error,
                            dialogueConfig: {
                                top: 85, left: 50, width: 180, height: 50, fontSize: 11
                            }
                        }))
                    };
                    App.state.storyPages.push(newPageData);
                    App.render();
                    App.ui.showToast("¡Página añadida a tu historia!");
                    App.ui.switchTab('story');
                }
            },
            
            handlers: {
                toggleMusic() {
                    // If the audio player doesn't exist yet, create it on the first click.
                    if (!App.state.audioPlayer) {
                        App.state.audioPlayer = new Audio('https://cdn.pixabay.com/audio/2022/02/07/audio_c4d51b38b3.mp3');
                        App.state.audioPlayer.loop = true;
                    }

                    const { audioPlayer } = App.state;
                    
                    if (audioPlayer.paused) {
                        const playPromise = audioPlayer.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                App.state.isMusicPlaying = true;
                                App.dom.musicIconOn.classList.remove('hidden');
                                App.dom.musicIconOff.classList.add('hidden');
                            }).catch(error => {
                                console.error("Audio playback failed:", error);
                                App.ui.showToast("Para activar el audio, haz clic de nuevo en el altavoz.");
                                App.state.isMusicPlaying = false;
                                App.dom.musicIconOn.classList.add('hidden');
                                App.dom.musicIconOff.classList.remove('hidden');
                            });
                        }
                    } else {
                        audioPlayer.pause();
                        App.state.isMusicPlaying = false;
                        App.dom.musicIconOn.classList.add('hidden');
                        App.dom.musicIconOff.classList.remove('hidden');
                    }
                },
                async resizeImage(file) {
                    const MAX_DIMENSION = 1024;
                    const reader = new FileReader();
                    return new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                let { width, height } = img;
                                if (width > height) {
                                    if (width > MAX_DIMENSION) { height *= MAX_DIMENSION / width; width = MAX_DIMENSION; }
                                } else {
                                    if (height > MAX_DIMENSION) { width *= MAX_DIMENSION / height; height = MAX_DIMENSION; }
                                }
                                const canvas = document.createElement('canvas');
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                resolve(canvas.toDataURL('image/jpeg', 0.9)); // Use JPEG for better compression
                            };
                            img.onerror = reject;
                            img.src = e.target.result;
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                },
                async handleGuideImageUpload(e, stateKey) {
                    const file = e.target.files[0];
                    if (!file) return;
                    App.ui.showToast("Optimizando imagen...");
                    try {
                        const resizedDataUrl = await this.resizeImage(file);
                        App.state[stateKey] = resizedDataUrl;
                        
                        const isComplement = stateKey === 'guideComplementImage';
                        const preview = isComplement ? App.dom.guideComplementPreview : App.dom.guideImagePreview;
                        const placeholder = isComplement ? App.dom.guideComplementPlaceholder : App.dom.guideImagePlaceholder;
                        const removeBtn = isComplement ? App.dom.removeGuideComplementBtn : App.dom.removeGuideImageBtn;

                        preview.src = resizedDataUrl;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        removeBtn.classList.remove('hidden');
                        App.ui.showToast("Imagen lista.");
                    } catch (error) {
                        App.ui.showErrorModal("No se pudo procesar la imagen. Intenta con otra.");
                        console.error("Error resizing image:", error);
                    }
                },
                handleRemoveGuideImage(e, stateKey) {
                    e.preventDefault(); e.stopPropagation();
                    App.state[stateKey] = null;

                    const isComplement = stateKey === 'guideComplementImage';
                    const uploadInput = isComplement ? App.dom.guideComplementUpload : App.dom.guideImageUpload;
                    const preview = isComplement ? App.dom.guideComplementPreview : App.dom.guideImagePreview;
                    const placeholder = isComplement ? App.dom.guideComplementPlaceholder : App.dom.guideImagePlaceholder;
                    const removeBtn = isComplement ? App.dom.removeGuideComplementBtn : App.dom.removeGuideImageBtn;

                    uploadInput.value = '';
                    preview.src = '';
                    preview.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                    removeBtn.classList.add('hidden');
                },
                async handleStoryBoardClick(e) {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    e.preventDefault();

                    const { action, pageId } = button.dataset;
                    const pageIndex = App.state.storyPages.findIndex(p => p.id === pageId);
                    if (pageIndex === -1) return;
                    
                    if (action === 'add-to-animation') {
                        App.handlers.captureAndProcessPage(pageIndex, (imageDataUrl) => {
                            App.animation.addFrame(imageDataUrl);
                        });
                    } else if (action === 'download') { 
                        App.handlers.captureAndProcessPage(pageIndex, (imageDataUrl, blob) => {
                            const blobUrl = URL.createObjectURL(blob);
                            const link = document.createElement('a'); 
                            link.href = blobUrl; 
                            link.download = `manga-page-${pageIndex + 1}.png`; 
                            link.className = 'btn btn-primary'; 
                            link.textContent = 'Descargar Página'; 
                            App.ui.showDownloadModal(link);
                        });
                    } else if (action === 'delete') { 
                        App.state.storyPages.splice(pageIndex, 1); 
                        App.render(); 
                        App.ui.showToast("Página eliminada."); 
                    }
                },
                async captureAndProcessPage(pageIndex, callback) {
                    const pageData = App.state.storyPages[pageIndex];
                    const tempCanvas = document.createElement('div');
                    tempCanvas.style.position = 'absolute';
                    tempCanvas.style.left = '-9999px';
                    tempCanvas.style.width = '1000px'; 
                    document.body.appendChild(tempCanvas);

                    const imageLoadPromises = pageData.panels
                        .filter(p => p.imageUrl)
                        .map(p => new Promise((resolve) => {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.onload = resolve;
                            img.onerror = resolve; 
                            img.src = p.imageUrl;
                        }));
                    
                    await Promise.all(imageLoadPromises);
                    
                    App.ui.renderPage(tempCanvas, pageData);
                    App.ui.showToast("Procesando página...");

                    try {
                        const canvas = await html2canvas(tempCanvas, { scale: 4, useCORS: true, backgroundColor: '#ffffff', logging: false });
                        document.body.removeChild(tempCanvas);
                        const imageDataUrl = canvas.toDataURL('image/png', 1.0);
                        canvas.toBlob(blob => {
                            callback(imageDataUrl, blob);
                        }, 'image/png');
                    } catch(err) {
                        document.body.removeChild(tempCanvas);
                        App.ui.showErrorModal("No se pudo generar la imagen para la acción solicitada.");
                        console.error("Error during canvas capture:", err);
                    }
                },
                handleDragStart(e) {
                    const target = e.target;
                    if (target.classList.contains('manga-panel')) {
                        App.state.draggedPanelInfo = {
                            pageId: target.dataset.pageId,
                            panelId: target.dataset.panelId
                        };
                        e.dataTransfer.effectAllowed = 'move';
                    }
                },
                handleDragOver(e) {
                    e.preventDefault();
                    const target = e.target;
                    if (target.classList.contains('manga-panel')) {
                        target.classList.add('drag-over');
                        e.dataTransfer.dropEffect = 'move';
                    }
                },
                handleDragLeave(e) {
                    const target = e.target;
                    if (target.classList.contains('manga-panel')) {
                        target.classList.remove('drag-over');
                    }
                },
                handleDrop(e) {
                    e.preventDefault();
                    const target = e.target;
                    if (!target.classList.contains('manga-panel') || !App.state.draggedPanelInfo) {
                        return;
                    }
                    target.classList.remove('drag-over');

                    const { pageId: fromPageId, panelId: fromPanelId } = App.state.draggedPanelInfo;
                    const { pageId: toPageId, panelId: toPanelId } = target.dataset;

                    if (fromPageId === toPageId && fromPanelId === toPanelId) return;

                    const fromPageIndex = App.state.storyPages.findIndex(p => p.id === fromPageId);
                    const fromPanelIndex = App.state.storyPages[fromPageIndex].panels.findIndex(p => p.id === fromPanelId);
                    
                    const toPageIndex = App.state.storyPages.findIndex(p => p.id === toPageId);
                    const toPanelIndex = App.state.storyPages[toPageIndex].panels.findIndex(p => p.id === toPanelId);

                    const fromPanelData = App.state.storyPages[fromPageIndex].panels[fromPanelIndex];
                    const toPanelData = App.state.storyPages[toPageIndex].panels[toPanelIndex];
                    
                    // Swap the panel data
                    App.state.storyPages[fromPageIndex].panels[fromPanelIndex] = toPanelData;
                    App.state.storyPages[toPageIndex].panels[toPanelIndex] = fromPanelData;
                    
                    App.render();
                    App.ui.showToast("Viñeta intercambiada.");
                    App.state.draggedPanelInfo = null;
                },
                handleStoryBoardDblClick(e) {
                    const panel = e.target.closest('.manga-panel');
                    if (panel) {
                        const pageId = panel.dataset.pageId;
                        const panelId = panel.dataset.panelId;
                        const page = App.state.storyPages.find(p => p.id === pageId);
                        const panelData = page?.panels.find(p => p.id === panelId);
                        
                        if(panelData && panelData.dialogue !== undefined) {
                            this.createDialogueEditor(panel, pageId, panelId, panelData);
                        }
                    }
                },
                createDialogueEditor(panelElement, pageId, panelId, panelData) {
                    const existingEditor = document.getElementById('dialogue-editor-wrapper');
                    if (existingEditor) existingEditor.remove();

                    const bubble = panelElement.querySelector('.dialogue-bubble');
                    if(bubble) bubble.style.display = 'none';

                    const defaultConfig = { width: 180, height: 60, top: 80, left: 50, fontSize: 11 };
                    const config = { ...defaultConfig, ...panelData.dialogueConfig };

                    const editorWrapper = document.createElement('div');
                    editorWrapper.id = 'dialogue-editor-wrapper';
                    editorWrapper.className = 'dialogue-editor-wrapper';
                    editorWrapper.style.width = `${config.width}px`;
                    editorWrapper.style.height = `${config.height}px`;
                    editorWrapper.style.top = `${config.top}%`;
                    editorWrapper.style.left = `${config.left}%`;
                    editorWrapper.style.transform = 'translate(-50%, -50%)';

                    const textarea = document.createElement('textarea');
                    textarea.className = 'dialogue-editor';
                    textarea.value = panelData.dialogue;
                    textarea.style.fontSize = `${config.fontSize}px`;

                    const resizeHandle = document.createElement('div');
                    resizeHandle.className = 'resize-handle';
                    
                    const fontControls = document.createElement('div');
                    fontControls.className = 'font-size-controls';
                    fontControls.innerHTML = `
                        <button class="font-size-btn" data-action="decrease-font">-</button>
                        <button class="font-size-btn" data-action="increase-font">+</button>
                    `;

                    editorWrapper.appendChild(fontControls);
                    editorWrapper.appendChild(textarea);
                    editorWrapper.appendChild(resizeHandle);
                    panelElement.appendChild(editorWrapper);
                    
                    textarea.focus();

                    const saveChanges = () => {
                        const newConfig = {
                            text: textarea.value,
                            width: parseInt(editorWrapper.style.width),
                            height: parseInt(editorWrapper.style.height),
                            top: parseFloat(editorWrapper.style.top),
                            left: parseFloat(editorWrapper.style.left),
                            fontSize: parseFloat(textarea.style.fontSize)
                        };
                        
                        const page = App.state.storyPages.find(p => p.id === pageId);
                        const panel = page?.panels.find(p => p.id === panelId);
                        if (panel) {
                            panel.dialogue = newConfig.text;
                            panel.dialogueConfig = newConfig;
                        }
                        editorWrapper.remove();
                        if(bubble) bubble.style.display = 'block';
                        App.render();
                        document.removeEventListener('click', closeOnOutsideClick);
                    };
                    
                    const closeOnOutsideClick = (e) => {
                         if (!editorWrapper.contains(e.target)) {
                            saveChanges();
                         }
                    };
                    setTimeout(() => document.addEventListener('click', closeOnOutsideClick), 0);

                    editorWrapper.addEventListener('click', e => e.stopPropagation());

                    // Dragging logic
                    let isDragging = false;
                    let initialX, initialY, offsetX, offsetY;
                    editorWrapper.addEventListener('mousedown', (e) => {
                        if (e.target !== resizeHandle) {
                           isDragging = true;
                           initialX = e.clientX;
                           initialY = e.clientY;
                           const rect = editorWrapper.getBoundingClientRect();
                           const parentRect = panelElement.getBoundingClientRect();
                           offsetX = rect.left - parentRect.left;
                           offsetY = rect.top - parentRect.top;
                           editorWrapper.style.cursor = 'grabbing';
                        }
                    });

                    // Resizing logic
                    let isResizing = false;
                    resizeHandle.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        initialX = e.clientX;
                        initialY = e.clientY;
                        const rect = editorWrapper.getBoundingClientRect();
                        offsetX = rect.width;
                        offsetY = rect.height;
                    });

                    panelElement.addEventListener('mousemove', (e) => {
                        if (isDragging) {
                            const dx = e.clientX - initialX;
                            const dy = e.clientY - initialY;
                            const newX = ((offsetX + dx) / panelElement.offsetWidth) * 100 + (editorWrapper.offsetWidth / 2 / panelElement.offsetWidth * 100);
                            const newY = ((offsetY + dy) / panelElement.offsetHeight) * 100 + (editorWrapper.offsetHeight / 2 / panelElement.offsetHeight * 100);
                            editorWrapper.style.left = `${Math.max(0, Math.min(100, newX))}%`;
                            editorWrapper.style.top = `${Math.max(0, Math.min(100, newY))}%`;
                        } else if (isResizing) {
                            const dx = e.clientX - initialX;
                            const dy = e.clientY - initialY;
                            editorWrapper.style.width = `${Math.max(50, offsetX + dx)}px`;
                            editorWrapper.style.height = `${Math.max(30, offsetY + dy)}px`;
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        isDragging = false;
                        isResizing = false;
                        editorWrapper.style.cursor = 'move';
                    });
                    
                    fontControls.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        let currentSize = parseFloat(textarea.style.fontSize) || config.fontSize;
                        if(action === 'increase-font') {
                            currentSize += 1;
                        } else if(action === 'decrease-font') {
                            currentSize = Math.max(8, currentSize - 1); // Minimum font size of 8px
                        }
                        textarea.style.fontSize = `${currentSize}px`;
                    });
                },
                 handleZoomChange(e) {
                    const value = e.target.value;
                    App.dom.dynamicStoryStyles.innerHTML = `.story-page-wrapper { width: calc(${value}% - 2rem); }`;
                }
            },
            
            animation: {
                addFrame(src) { App.state.animationFrames.push(src); App.ui.updateAnimationFramesUI(); App.ui.showToast(`Página añadida a la animación. Total: ${App.state.animationFrames.length}`); App.ui.switchTab('animation'); },
                playNextFrame(currentFrameIndex) {
                    const { animImg1, animImg2 } = App.dom; const { activeAnimImage, animationFrames, currentTransition } = App.state;
                    const nextFrameIndex = (currentFrameIndex + 1) % animationFrames.length;
                    const nextImageSrc = animationFrames[nextFrameIndex];
                    const currentImg = activeAnimImage; const nextImg = (currentImg === animImg1) ? animImg2 : animImg1;
                    nextImg.src = nextImageSrc;
                    if(currentTransition === 'none') { currentImg.classList.add('anim-img-hidden'); nextImg.classList.remove('anim-img-hidden'); } 
                    else if (currentTransition === 'fade') { currentImg.classList.add('fade-out'); currentImg.classList.remove('fade-in'); nextImg.classList.remove('fade-out', 'anim-img-hidden'); nextImg.classList.add('fade-in'); } 
                    else if (currentTransition === 'slide') { currentImg.classList.add('slide-out'); nextImg.classList.add('slide-in-initial'); nextImg.classList.remove('anim-img-hidden'); void nextImg.offsetWidth; nextImg.classList.remove('slide-in-initial'); nextImg.classList.add('slide-in'); }
                    App.state.activeAnimImage = nextImg;
                    return nextFrameIndex;
                },
                toggle() {
                    if (App.state.animationFrames.length < 1) return;
                    App.state.isPlaying = !App.state.isPlaying;
                    App.dom.playPauseBtn.textContent = App.state.isPlaying ? '❚❚ Pause' : '▶ Play';
                    if (App.state.isPlaying) {
                        let currentFrame = App.state.animationFrames.indexOf(App.state.activeAnimImage.src);
                        if(currentFrame === -1) currentFrame = 0;
                        clearInterval(App.state.animationInterval);
                        App.state.animationInterval = setInterval(() => { if (App.state.animationFrames.length === 0) { this.toggle(); return; } currentFrame = this.playNextFrame(currentFrame); }, 1000 / App.state.fps);
                    } else { clearInterval(App.state.animationInterval); }
                },
                setFps(value) { App.state.fps = parseInt(value, 10); App.dom.fpsValue.textContent = App.state.fps; if (App.state.isPlaying) { this.toggle(); this.toggle(); } },
                setTransition(value) { App.state.currentTransition = value; },
                clear() { if (App.state.isPlaying) this.toggle(); App.state.animationFrames = []; App.render(); },
                async download() {
                    if (App.state.animationFrames.length === 0) { App.ui.showErrorModal("No hay frames para descargar."); return; }
                    if (typeof GIF === 'undefined') { App.ui.showErrorModal("La librería de animación (gif.js) no se ha cargado."); return; }
                    App.ui.setPageLoading(true, `Preparando GIF... 0/${App.state.animationFrames.length}`);
                    try {
                        const gif = new GIF({ workers: 2, quality: 10, width: 500, height: 750, });
                        const imagePromises = App.state.animationFrames.map(src => new Promise((resolve, reject) => { const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => resolve(img); img.onerror = reject; img.src = src; }));
                        const loadedImages = await Promise.all(imagePromises);
                        for (let i = 0; i < loadedImages.length; i++) { App.ui.setPageLoading(true, `Procesando frame ${i + 1}/${loadedImages.length}`); gif.addFrame(loadedImages[i], { delay: 1000 / App.state.fps }); }
                        gif.on('finished', function(blob) { App.ui.setPageLoading(false); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = 'manga-studio-animation.gif'; link.className = 'btn btn-primary'; link.textContent = 'Descargar Animación GIF'; App.ui.showDownloadModal(link); });
                        gif.on('progress', function(p) { App.ui.setPageLoading(true, `Renderizando GIF: ${Math.round(p * 100)}%`); });
                        gif.render();
                    } catch (error) { console.error("Error creando el GIF:", error); App.ui.showErrorModal("No se pudo crear el GIF. Puede que alguna imagen no se haya cargado bien."); App.ui.setPageLoading(false); }
                }
            }
        };

        App.init();
    });
    </script>
</body>
</html>




