<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Studio AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4dFVxBKTJMasibMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #10111a;
            --bg-medium: #1a1a2e;
            --primary: #e94560;
            --primary-glow: rgba(233, 69, 96, 0.4);
            --secondary: #4a4a6a;
            --text-light: #f0f0f5;
            --text-medium: #a0a0b0;
            --border-color: rgba(255, 255, 255, 0.1);
            --transition-speed: 0.5s;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark); /* Fallback */
            background-image: 
                linear-gradient(rgba(16, 17, 26, 0.92), rgba(16, 17, 26, 0.98)),
                url('https://w.wallhaven.cc/full/zy/wallhaven-zygeko.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-light);
        }

        .tab-btn {
            position: relative;
            transition: color 0.3s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .tab-btn.active { color: white; }
        .tab-btn.active::after { width: 100%; }

        .glass-card {
            background: rgba(23, 23, 39, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #e94560 0%, #ff5e78 100%);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--primary-glow);
        }
        .btn-primary:disabled {
            background: #992d3e;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #6a6a8a;
            transform: translateY(-2px);
        }
        
        .form-input, .form-select, .form-textarea {
            background-color: #2a2a4a;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 0.75rem;
            padding: 0.75rem;
            transition: all 0.2s ease;
            width: 100%;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }
        .form-checkbox {
            appearance: none;
            background-color: #2a2a4a;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .form-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-glow);
        }


        .loader {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background: #ff5e78; }
        
        #page-canvas {
            background-color: white;
            display: grid;
            gap: 10px;
            padding: 10px;
            aspect-ratio: 2 / 3;
            max-width: 500px;
            margin: auto;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }
        #page-canvas:hover {
            transform: scale(1.02);
        }

        .manga-panel {
            border: 2px solid #1a1a2e;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .dialogue-bubble {
            position: absolute;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 250px;
            background-color: white;
            color: black;
            padding: 8px 12px;
            border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
            border: 2px solid black;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-size: 11px;
            line-height: 1.3;
        }
        .dialogue-bubble::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border-right: 2px solid black;
            border-bottom: 2px solid black;
            transform: rotate(45deg);
            bottom: -7px;
            left: 30%;
        }
        .db-font {
            font-family: 'Bangers', cursive;
            letter-spacing: 2px;
            -webkit-text-stroke: 1.5px black;
        }

        /* --- Animation Preview --- */
        #animation-preview-container {
            position: relative;
            overflow: hidden;
        }
        #animation-preview-container img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
            transition: opacity var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
        }
        .anim-img-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .anim-img-visible {
            opacity: 1;
        }

        /* --- Transition Effects --- */
        /* Fade */
        .fade-out { opacity: 0 !important; }
        .fade-in { opacity: 1 !important; }

        /* Slide */
        .slide-out { transform: translateX(-100%); opacity: 0; }
        .slide-in { transform: translateX(0); opacity: 1; }
        .slide-in-initial { transform: translateX(100%); opacity: 0; }


    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <div class="flex items-center justify-center gap-4">
                <svg class="w-12 h-12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#F57C00" stroke="#000000" stroke-width="1"></circle>
                    <path d="M12 7L13.53 10.96L18 10.96L14.73 13.54L16.26 17.5L12 15.04L7.74 17.5L9.27 13.54L6 10.96L10.47 10.96L12 7Z" fill="#D32F2F" stroke="#BF240A" stroke-width="0.5"></path>
                </svg>
                <h1 class="text-4xl md:text-5xl font-bold text-orange-500 db-font">
                    Manga Studio <span class="text-red-600">AI</span>
                </h1>
                <span class="text-sm font-semibold align-top bg-yellow-400 text-black rounded-full px-3 py-1 shadow-lg animate-pulse">PRO</span>
            </div>
            <p class="text-lg text-text-medium mt-2">Tu estudio creativo para dar vida a tus historias</p>
        </header>

        <!-- Pestañas de Navegación -->
        <nav class="flex flex-wrap justify-center mb-10 border-b border-border-color">
            <button data-tab="page" class="tab-btn active text-lg font-semibold py-4 px-6 text-text-medium">Generador</button>
            <button data-tab="story" class="tab-btn text-lg font-semibold py-4 px-6 text-text-medium">Historia</button>
            <button data-tab="animation" class="tab-btn text-lg font-semibold py-4 px-6 text-text-medium">Animación</button>
        </nav>

        <main>
            <!-- Panel Generador de Páginas -->
            <div id="page-panel" data-panel="page">
                <div class="glass-card p-6 md:p-8">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-3xl font-bold mb-2 text-white text-center">Creador de Páginas</h2>
                        <p class="text-center text-text-medium mb-8">Construye tu escena con detalles para obtener el mejor resultado.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block mb-2 text-md font-semibold text-text-light">Guía del Protagonista (Opcional)</label>
                                <div id="guide-image-dropzone" class="relative flex flex-col items-center justify-center w-full h-40 border-2 border-border-color border-dashed rounded-xl cursor-pointer bg-black/20 hover:bg-black/30">
                                    <div id="guide-image-placeholder" class="absolute flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                        <svg class="w-8 h-8 mb-4 text-text-medium" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                        <p class="mb-2 text-sm text-text-medium"><span class="font-semibold">Sube una imagen de tu personaje</span></p>
                                    </div>
                                    <img id="guide-image-preview" class="hidden w-full h-full object-contain rounded-lg p-2" />
                                    <button id="remove-guide-image-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-sm">&times;</button>
                                    <input id="guide-image-upload" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" />
                                </div>
                            </div>
                            <div>
                                <label class="block mb-2 text-md font-semibold text-text-light">Complemento de Guía (Opcional)</label>
                                <div id="guide-complement-dropzone" class="relative flex flex-col items-center justify-center w-full h-40 border-2 border-border-color border-dashed rounded-xl cursor-pointer bg-black/20 hover:bg-black/30">
                                    <div id="guide-complement-placeholder" class="absolute flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                        <svg class="w-8 h-8 mb-4 text-text-medium" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                        <p class="mb-2 text-sm text-text-medium"><span class="font-semibold">Sube un coche, accesorio, etc.</span></p>
                                    </div>
                                    <img id="guide-complement-preview" class="hidden w-full h-full object-contain rounded-lg p-2" />
                                    <button id="remove-guide-complement-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-sm">&times;</button>
                                    <input id="guide-complement-upload" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*" />
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="prompt-characters" class="block mb-2 text-md font-semibold text-text-light">1. Personajes en la Escena</label>
                                <textarea id="prompt-characters" rows="3" class="form-textarea" placeholder="Ej: El personaje de la 'imagen guia' y su rival, un guerrero veterano con una cicatriz."></textarea>
                            </div>
                            <div>
                                <label for="prompt-setting" class="block mb-2 text-md font-semibold text-text-light">2. Lugar y Ambiente</label>
                                <textarea id="prompt-setting" rows="3" class="form-textarea" placeholder="Ej: En un bosque oscuro, junto al coche del 'complemento guia'."></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="prompt-action" class="block mb-2 text-md font-semibold text-text-light">3. Acción Principal de la Página</label>
                                <textarea id="prompt-action" rows="4" class="form-textarea" placeholder="Ej: El guerrero protege a la maga de un ataque sorpresa. Ella prepara un hechizo de luz mientras él levanta su escudo. Hay un sentimiento de urgencia."></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div>
                                <label for="full-page-style" class="block mb-2 text-sm font-medium text-text-light">Estilo Visual</label>
                                <select id="full-page-style" class="form-select">
                                    <option value="estilo manga clasico en blanco y negro, alto detalle, sombreado de trama">Manga Clásico (B/N)</option>
                                    <option value="estilo anime moderno, colores vibrantes, iluminacion cinematografica">Anime Moderno (Color)</option>
                                    <option value="estilo inspirado en Studio Ghibli, fondos pintorescos de acuarela, personajes encantadores">Estilo Ghibli</option>
                                    <option value="estilo anime Shonen de los 90, accion dinamica, lineas fuertes, aspecto retro">Anime Shōnen (90s)</option>
                                    <option value="estilo Isekai, mundo de fantasia vibrante, elementos magicos, armaduras detalladas">Anime Isekai</option>
                                    <option value="estilo Slice of Life, colores calidos y suaves, escenas cotidianas, fondos urbanos o escolares">Anime Slice of Life</option>
                                    <option value="estilo fantasia historica, arquitectura de epoca, vestimenta detallada, atmosfera epica">Fantasía Histórica</option>
                                </select>
                            </div>
                            <div>
                                <label for="full-page-tone" class="block mb-2 text-sm font-medium text-text-light">Tono Narrativo</label>
                                <select id="full-page-tone" class="form-select">
                                    <option value="">Automático</option>
                                    <option value="con un tono dramatico y serio">Dramático</option>
                                    <option value="con un tono de comedia y humor">Comedia</option>
                                    <option value="con un tono de accion y ritmo rapido">Acción</option>
                                    <option value="con un tono de misterio e intriga">Misterio</option>
                                    <option value="con un tono romantico y emotivo">Romance</option>
                                </select>
                            </div>
                            <div>
                                <label for="full-page-arc" class="block mb-2 text-sm font-medium text-text-light">Punto de la Historia</label>
                                <select id="full-page-arc" class="form-select">
                                    <option value="">Automático</option>
                                    <option value="el principio (presentacion de personajes/conflicto)">Principio</option>
                                    <option value="el nudo (desarrollo, punto de inflexion)">Nudo (Desarrollo)</option>
                                    <option value="el desenlace (conclusion, climax final)">Desenlace (Final)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Potenciadores de Calidad -->
                        <div class="glass-card p-4 my-6 border border-sky-400/30">
                            <h4 class="text-lg font-semibold mb-4 text-center text-sky-300">Potenciadores de Calidad (Opcional)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="prompt-negative" class="block mb-2 text-sm font-medium text-text-light">Prompt Negativo</label>
                                    <textarea id="prompt-negative" rows="3" class="form-textarea text-sm" placeholder="Ej: manos deformes, mala anatomía, texto, firmas, borroso..."></textarea>
                                </div>
                                <div class="flex flex-col justify-center items-start pt-4">
                                     <label for="quality-booster" class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="quality-booster" class="form-checkbox">
                                        <span class="ml-3 text-text-light">Activar Potenciador Mágico</span>
                                    </label>
                                    <p class="text-xs text-text-medium mt-2 ml-3">Añade automáticamente términos como "obra maestra, alta resolución, ultra detallado..." para mejorar la calidad.</p>
                                </div>
                            </div>
                        </div>


                        <button id="generate-full-page-btn" class="btn btn-primary w-full text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            ¡Crear Página Mágica!
                        </button>

                        <div id="page-loader" class="hidden flex-col items-center mt-8">
                            <div class="loader"></div>
                            <p id="page-loader-text" class="mt-4 text-text-medium">Creando tu página...</p>
                        </div>
                        
                        <div id="page-result-area" class="mt-8">
                            <div id="page-canvas">
                                <div class="manga-panel flex items-center justify-center text-center text-text-medium p-4">
                                    <p>Tu página de manga aparecerá aquí.</p>
                                </div>
                            </div>
                            <div id="page-actions-wrapper" class="hidden flex-wrap items-center justify-center gap-4 mt-6">
                                <button id="add-to-story-btn" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
                                    Añadir a la Historia
                                </button>
                                <button id="continue-story-btn" class="btn btn-primary">
                                    Continuar Historia 
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Editor de Historia -->
            <div id="story-panel" data-panel="story" class="hidden">
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-3xl font-bold mb-2 text-white text-center">Editor de Historia</h2>
                    <p class="text-center text-text-medium mb-8">Aquí se guardan todas las páginas de tu manga. Organiza, previsualiza y descarga tu obra completa.</p>
                    <div id="story-board-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div id="story-placeholder" class="col-span-full text-center text-text-medium p-10 border-2 border-dashed border-border-color rounded-lg">
                            <p class="text-lg">Tu historia está en blanco.</p>
                            <p>Ve al "Generador" para empezar a crear y añadir tus páginas aquí.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="animation-panel" data-panel="animation" class="hidden">
                <div class="glass-card p-6 md:p-8">
                    <h2 class="text-3xl font-bold mb-2 text-white text-center">Estudio de Animación</h2>
                    <p class="text-center text-text-medium mb-8">Crea animaciones sencillas con tus imágenes.</p>

                    <div class="text-center mb-6 bg-yellow-900/50 border border-yellow-700 p-3 rounded-xl">
                        <p><strong>Nota:</strong> Guarda páginas en tu <span class="font-bold">Historia</span> para poder añadirlas a la animación.</p>
                    </div>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h3 class="font-semibold mb-3 text-lg">Paneles / Frames</h3>
                            <div id="animation-frames" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-3 gap-2 p-2 bg-black/20 rounded-xl min-h-[100px] max-h-96 overflow-y-auto">
                                <p id="frames-placeholder" class="col-span-full text-center text-text-medium p-4">Añade páginas desde la pestaña Historia.</p>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div id="animation-preview-container" class="aspect-[2/3] max-w-[350px] mx-auto bg-black rounded-lg flex items-center justify-center border-2 border-border-color overflow-hidden">
                                <img id="anim-img-1" class="anim-img-hidden" alt="Frame de animación 1">
                                <img id="anim-img-2" class="anim-img-hidden" alt="Frame de animación 2">
                            </div>
                            <div class="mt-4 flex flex-col md:flex-row items-center justify-center flex-wrap gap-4">
                                <button id="play-pause-btn" class="btn btn-primary py-2 px-6 text-lg">▶ Play</button>
                                <div class="flex items-center gap-2">
                                    <label for="fps-slider">Velocidad (FPS):</label>
                                    <input type="range" id="fps-slider" min="1" max="24" value="5" class="w-24">
                                    <span id="fps-value" class="font-mono">5</span>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <label for="transition-select">Transición:</label>
                                    <select id="transition-select" class="form-select !w-auto !py-1 !px-2 !text-sm">
                                        <option value="none">Ninguna</option>
                                        <option value="fade">Fundido</option>
                                        <option value="slide">Deslizar</option>
                                    </select>
                                </div>
                                <button id="clear-animation-btn" class="btn bg-red-600 hover:bg-red-700">Limpiar</button>
                                <button id="download-animation-btn" class="btn btn-secondary w-full md:w-auto mt-2 md:mt-0">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Descargar Animación (GIF)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-red-500 rounded-lg p-6 max-w-sm w-full text-center shadow-lg">
            <h3 class="text-xl font-bold text-red-500 mb-2">Error</h3>
            <p id="error-message" class="text-gray-300 mb-4"></p>
            <button id="close-error-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded">Cerrar</button>
        </div>
    </div>
    
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg z-50">
        <p id="toast-message"></p>
    </div>
    
    <div id="download-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-green-500 rounded-lg p-6 max-w-sm w-full text-center shadow-lg">
            <h3 class="text-xl font-bold text-green-400 mb-2">Archivo Listo</h3>
            <p class="text-gray-300 mb-4">Tu archivo está listo para ser descargado.</p>
            <div id="download-modal-content" class="my-4"></div>
            <button id="close-download-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancelar</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const App = {
            state: {
                activeTab: 'page',
                animationFrames: [],
                storyPages: [],
                isPlaying: false,
                animationInterval: null,
                fps: 5,
                guideImage: null,
                guideComplementImage: null,
                lastGeneratedScript: null,
                lastPrompt: '',
                useGuideImageForCurrentStory: false,
                useGuideComplementForCurrentStory: false,
                currentTransition: 'fade',
                activeAnimImage: null,
            },

            dom: {},

            init() {
                this.cacheDom();
                this.bindEvents();
                this.render();
            },

            cacheDom() {
                this.dom.tabButtons = document.querySelectorAll('.tab-btn');
                this.dom.panels = document.querySelectorAll('[data-panel]');
                this.dom.guideImageUpload = document.getElementById('guide-image-upload');
                this.dom.guideImagePreview = document.getElementById('guide-image-preview');
                this.dom.guideImagePlaceholder = document.getElementById('guide-image-placeholder');
                this.dom.removeGuideImageBtn = document.getElementById('remove-guide-image-btn');
                this.dom.guideComplementUpload = document.getElementById('guide-complement-upload');
                this.dom.guideComplementPreview = document.getElementById('guide-complement-preview');
                this.dom.guideComplementPlaceholder = document.getElementById('guide-complement-placeholder');
                this.dom.removeGuideComplementBtn = document.getElementById('remove-guide-complement-btn');
                this.dom.promptCharacters = document.getElementById('prompt-characters');
                this.dom.promptSetting = document.getElementById('prompt-setting');
                this.dom.promptAction = document.getElementById('prompt-action');
                this.dom.fullPageStyle = document.getElementById('full-page-style');
                this.dom.fullPageTone = document.getElementById('full-page-tone');
                this.dom.fullPageArc = document.getElementById('full-page-arc');
                this.dom.generateBtn = document.getElementById('generate-full-page-btn');
                this.dom.continueBtn = document.getElementById('continue-story-btn');
                this.dom.addToStoryBtn = document.getElementById('add-to-story-btn');
                this.dom.pageLoader = document.getElementById('page-loader');
                this.dom.pageLoaderText = document.getElementById('page-loader-text');
                this.dom.pageCanvas = document.getElementById('page-canvas');
                this.dom.pageActionsWrapper = document.getElementById('page-actions-wrapper');
                this.dom.promptNegative = document.getElementById('prompt-negative');
                this.dom.qualityBooster = document.getElementById('quality-booster');
                this.dom.storyBoardContainer = document.getElementById('story-board-container');
                this.dom.storyPlaceholder = document.getElementById('story-placeholder');
                this.dom.animationFramesContainer = document.getElementById('animation-frames');
                this.dom.framesPlaceholder = document.getElementById('frames-placeholder');
                this.dom.animImg1 = document.getElementById('anim-img-1');
                this.dom.animImg2 = document.getElementById('anim-img-2');
                this.dom.playPauseBtn = document.getElementById('play-pause-btn');
                this.dom.fpsSlider = document.getElementById('fps-slider');
                this.dom.fpsValue = document.getElementById('fps-value');
                this.dom.clearAnimationBtn = document.getElementById('clear-animation-btn');
                this.dom.transitionSelect = document.getElementById('transition-select');
                this.dom.downloadAnimationBtn = document.getElementById('download-animation-btn');
                this.dom.errorModal = document.getElementById('error-modal');
                this.dom.errorMessage = document.getElementById('error-message');
                this.dom.closeErrorModalBtn = document.getElementById('close-error-modal-btn');
                this.dom.toast = document.getElementById('toast-notification');
                this.dom.toastMessage = document.getElementById('toast-message');
                this.dom.downloadModal = document.getElementById('download-modal');
                this.dom.downloadModalContent = document.getElementById('download-modal-content');
                this.dom.closeDownloadModalBtn = document.getElementById('close-download-modal-btn');
            },

            bindEvents() {
                this.dom.tabButtons.forEach(btn => btn.addEventListener('click', () => this.ui.switchTab(btn.dataset.tab)));
                this.dom.generateBtn.addEventListener('click', () => this.flows.generateFullPage());
                this.dom.continueBtn.addEventListener('click', () => this.flows.continueStory());
                this.dom.addToStoryBtn.addEventListener('click', () => this.flows.addPageToStory());
                this.dom.guideImageUpload.addEventListener('change', (e) => this.handlers.handleGuideImageUpload(e));
                this.dom.removeGuideImageBtn.addEventListener('click', (e) => this.handlers.handleRemoveGuideImage(e));
                this.dom.guideComplementUpload.addEventListener('change', (e) => this.handlers.handleGuideComplementUpload(e));
                this.dom.removeGuideComplementBtn.addEventListener('click', (e) => this.handlers.handleRemoveGuideComplement(e));
                this.dom.playPauseBtn.addEventListener('click', () => this.animation.toggle());
                this.dom.clearAnimationBtn.addEventListener('click', () => this.animation.clear());
                this.dom.fpsSlider.addEventListener('input', (e) => this.animation.setFps(e.target.value));
                this.dom.transitionSelect.addEventListener('change', (e) => this.animation.setTransition(e.target.value));
                this.dom.downloadAnimationBtn.addEventListener('click', () => this.animation.download());
                this.dom.closeErrorModalBtn.addEventListener('click', () => this.ui.showErrorModal(null));
                this.dom.closeDownloadModalBtn.addEventListener('click', () => this.ui.showDownloadModal(null));
                this.dom.storyBoardContainer.addEventListener('click', (e) => this.handlers.handleStoryBoardClick(e));
            },
            
            render() {
                this.ui.updateTabUI();
                this.ui.updateStoryEditorUI();
                this.ui.updateAnimationFramesUI();
            },
            
            ui: {
                switchTab(tabName) {
                    App.state.activeTab = tabName;
                    App.render();
                },
                updateTabUI() {
                    App.dom.panels.forEach(p => p.classList.toggle('hidden', p.dataset.panel !== App.state.activeTab));
                    App.dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === App.state.activeTab));
                },
                showErrorModal(message) {
                    if (message) {
                        App.dom.errorMessage.textContent = message;
                        App.dom.errorModal.classList.remove('hidden');
                    } else {
                        App.dom.errorModal.classList.add('hidden');
                    }
                },
                showDownloadModal(linkElement) {
                    const { downloadModal, downloadModalContent } = App.dom;
                    if (linkElement) {
                        downloadModalContent.innerHTML = '';
                        downloadModalContent.appendChild(linkElement);
                        downloadModal.classList.remove('hidden');
                    } else {
                        downloadModal.classList.add('hidden');
                        const oldLink = downloadModalContent.querySelector('a');
                        if (oldLink && oldLink.href.startsWith('blob:')) {
                            URL.revokeObjectURL(oldLink.href);
                        }
                    }
                },
                showToast(message) {
                    App.dom.toastMessage.textContent = message;
                    App.dom.toast.classList.remove('hidden');
                    setTimeout(() => App.dom.toast.classList.add('hidden'), 3000);
                },
                setPageLoading(isLoading, text = '') {
                    App.dom.generateBtn.disabled = isLoading;
                    App.dom.continueBtn.disabled = isLoading;
                    App.dom.downloadAnimationBtn.disabled = isLoading;
                    App.dom.pageLoader.classList.toggle('hidden', !isLoading);
                    App.dom.pageLoader.classList.toggle('flex', isLoading);
                    App.dom.pageLoaderText.textContent = text;
                },
                renderGeneratedPage(panelData) {
                    const { pageCanvas } = App.dom;
                    pageCanvas.innerHTML = '';
                    const panelCount = panelData.length;
                    
                    if (panelCount === 0) {
                        pageCanvas.innerHTML = '<div class="manga-panel flex items-center justify-center text-center text-gray-500 p-4"><p>No se generaron viñetas.</p></div>';
                        return;
                    }

                    const layouts = {
                        1: { grid: 'grid-cols-1 grid-rows-1', panels: ['col-span-1 row-span-1'] },
                        2: [{ grid: 'grid-cols-1 grid-rows-2', panels: ['row-span-1', 'row-span-1'] }, { grid: 'grid-cols-2 grid-rows-1', panels: ['col-span-1', 'col-span-1'] }],
                        3: [{ grid: 'grid-cols-2 grid-rows-2', panels: ['col-span-2 row-span-1', 'col-span-1 row-span-1', 'col-span-1 row-span-1'] }, { grid: 'grid-cols-2 grid-rows-2', panels: ['col-span-1 row-span-2', 'col-span-1 row-span-1', 'col-span-1 row-span-1'] }],
                        4: [{ grid: 'grid-cols-2 grid-rows-2', panels: ['col-span-1', 'col-span-1', 'col-span-1', 'col-span-1'] }, { grid: 'grid-cols-2 grid-rows-3', panels: ['col-span-2 row-span-1', 'col-span-1 row-span-2', 'col-span-1 row-span-2'] }]
                    };

                    let selectedLayout = layouts[panelCount] ? (Array.isArray(layouts[panelCount]) ? layouts[panelCount][Math.floor(Math.random() * layouts[panelCount].length)] : layouts[panelCount]) : { grid: 'grid-cols-1', panels: [] };
                    
                    pageCanvas.className = 'grid p-2.5 gap-2.5 aspect-[2/3] max-w-[500px] mx-auto shadow-lg bg-white';
                    pageCanvas.classList.add(...selectedLayout.grid.split(' '));

                    panelData.forEach((data, index) => {
                        const panel = document.createElement('div');
                        panel.className = `manga-panel ${selectedLayout.panels[index] || ''}`;
                        if (data.imageUrl) {
                             panel.style.backgroundImage = `url(${data.imageUrl})`;
                        } else {
                            panel.innerHTML = `<div class="flex items-center justify-center h-full text-xs text-center text-red-500 bg-red-100 p-1">Error al generar imagen</div>`;
                        }

                        if (data.dialogue) {
                            const bubble = document.createElement('div');
                            bubble.className = 'dialogue-bubble';
                            bubble.textContent = data.dialogue;
                            panel.appendChild(bubble);
                        }
                        pageCanvas.appendChild(panel);
                    });
                },
                updateStoryEditorUI() {
                    const { storyBoardContainer, storyPlaceholder } = App.dom;
                    storyBoardContainer.innerHTML = '';
                    if (App.state.storyPages.length === 0) {
                        storyBoardContainer.appendChild(storyPlaceholder);
                    } else {
                        App.state.storyPages.forEach((src, index) => {
                            const pageWrapper = document.createElement('div');
                            pageWrapper.className = 'relative group border-2 border-border-color rounded-lg overflow-hidden shadow-lg';
                            pageWrapper.innerHTML = `
                                <img src="${src}" class="w-full h-auto object-contain" />
                                <div class="absolute top-2 left-2 bg-black/70 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">${index + 1}</div>
                                <div class="absolute inset-0 bg-black/70 flex flex-col items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button data-action="add-to-animation" data-index="${index}" class="btn btn-secondary py-2 px-4 text-sm">&#x2728; A Animación</button>
                                    <button data-action="download" data-index="${index}" class="btn btn-primary py-2 px-4 text-sm">&#x21E9; Descargar</button>
                                    <button data-action="delete" data-index="${index}" class="bg-red-600 hover:bg-red-700 text-white btn py-2 px-4 text-sm">&#x1F5D1; Eliminar</button>
                                </div>
                            `;
                            storyBoardContainer.appendChild(pageWrapper);
                        });
                    }
                },
                updateAnimationFramesUI() {
                     const { animationFramesContainer, framesPlaceholder, animImg1, animImg2 } = App.dom;
                    animationFramesContainer.innerHTML = '';
                    if (App.state.animationFrames.length === 0) {
                        framesPlaceholder.classList.remove('hidden');
                        animImg1.classList.add('anim-img-hidden');
                        animImg2.classList.add('anim-img-hidden');
                        animImg1.src = '';
                        animImg2.src = '';

                    } else {
                        framesPlaceholder.classList.add('hidden');
                        App.state.animationFrames.forEach(src => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'aspect-video flex items-center justify-center bg-black/20 rounded-lg p-1';
                            wrapper.innerHTML = `<img src="${src}" class="w-full h-auto object-contain rounded-md">`;
                            animationFramesContainer.appendChild(wrapper);
                        });
                        
                        if (!animImg1.src) {
                            animImg1.src = App.state.animationFrames[0];
                            animImg1.classList.remove('anim-img-hidden');
                            App.state.activeAnimImage = animImg1;
                        }
                    }
                }
            },

            api: {
                // NEW: This is our secure way to talk to the backend function
                async callProxy(target, payload) {
                    const proxyUrl = '/.netlify/functions/generate'; // The URL to our new function
                    try {
                        const response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target, payload })
                        });
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Error from server: ${response.status} - ${errorText}`);
                        }
                        return response.json();
                    } catch (error) {
                        console.error(`Error calling proxy function [${target}]:`, error);
                        throw error;
                    }
                },

                async generateScript(prompt, tone, arc) {
                    const systemPrompt = `Eres un experto guionista de manga. Tu tarea es tomar una idea y dividirla en un máximo de 4 viñetas (panels). Debes devolver EXCLUSIVAMENTE un objeto JSON. El JSON debe ser un array donde cada objeto representa una viñeta y contiene "panel" (número), "description" (una descripción visual detallada para un generador de imágenes de IA. IMPORTANTE: Si la idea menciona 'imagen guia' para un personaje, debes incluir la frase 'imagen guia' en la descripción de ese personaje. Si menciona un 'complemento guia' para un objeto o vehículo, debes incluir la frase 'complemento guia' en la descripción de ese objeto.), y "dialogue" (un texto corto para el bocadillo de diálogo, o una cadena vacía si no hay diálogo).`;
                    let userQuery = `Idea: "${prompt}". Divídela en 3 o 4 viñetas.`;
                    if (arc) userQuery = `Enfócate en ${arc} de la historia. ${userQuery}`;
                    if (tone) userQuery = `${userQuery} El tono de la historia debe ser ${tone}.`;

                    // This is the data we'll send to our backend function
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { panel: { "type": "NUMBER" }, description: { "type": "STRING" }, dialogue: { "type": "STRING" } }, required: ["panel", "description", "dialogue"] } } }
                    };

                    const result = await this.callProxy('script', payload); // Call our secure function
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("La IA no devolvió un guion válido.");
                    return JSON.parse(jsonText);
                },

                async generateImageForPanel(description, useGuideImage, useGuideComplement) {
                    const style = App.dom.fullPageStyle.value;
                    const negativePrompt = App.dom.promptNegative.value.trim();
                    const useBooster = App.dom.qualityBooster.checked;
                    
                    const payload = { contents: [{ parts: [] }], generationConfig: { responseModalities: ['IMAGE'] } };
                    
                    const wantsToUseGuide = useGuideImage && description.toLowerCase().includes('imagen guia');
                    const wantsToUseComplement = useGuideComplement && description.toLowerCase().includes('complemento guia');
                    const cleanDescription = description.replace(/\(imagen guia\)|imagen guia/gi, '').replace(/\(complemento guia\)|complemento guia/gi, '').trim();
                    
                    let promptParts = [];

                    if (wantsToUseGuide && App.state.guideImage) {
                        payload.contents[0].parts.push({ inlineData: { mimeType: "image/png", data: App.state.guideImage.split(',')[1] } });
                        promptParts.push("Toma a la persona de la primera imagen de referencia y redibújala EXACTAMENTE con el mismo rostro y peinado");
                    }

                    if (wantsToUseComplement && App.state.guideComplementImage) {
                        payload.contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: App.state.guideComplementImage.split(',')[1] } });
                        const referenceWord = wantsToUseGuide ? "segunda" : "primera";
                        promptParts.push(`Usa el objeto/vehículo de la ${referenceWord} imagen de referencia`);
                    }

                    let finalPrompt;
                    if (promptParts.length > 0) {
                        finalPrompt = `${promptParts.join(', ')}, pero con ${style}. Coloca estos elementos en la siguiente escena: ${cleanDescription}`;
                    } else {
                        finalPrompt = `Una imagen con ${style}, mostrando: ${cleanDescription}`;
                    }
                    if (useBooster) {
                        finalPrompt += ", obra maestra, alta resolución, ultra detallado, iluminación cinematográfica";
                    }
                    if (negativePrompt) {
                        finalPrompt += `. Importante: Evita estrictamente lo siguiente en la imagen: ${negativePrompt}.`;
                    }
                    
                    payload.contents[0].parts.push({ text: finalPrompt });
                    
                    const result = await this.callProxy('image', payload); // Call our secure function
                    const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                    const base64Data = imagePart?.inlineData?.data;

                    if (base64Data) {
                        return `data:image/png;base64,${base64Data}`;
                    } else {
                        const reason = result?.candidates?.[0]?.finishReason;
                        let errorMessage = "No se pudo generar una imagen.";
                        if (reason === 'SAFETY') errorMessage = `La imagen para "${description.substring(0, 30)}..." fue bloqueada por seguridad.`;
                        else errorMessage = `La generación falló por una razón desconocida (API Finish Reason: ${reason || 'N/A'}).`;
                        console.error("Fallo en la generación de imagen. Respuesta de la API:", JSON.stringify(result));
                        throw new Error(errorMessage);
                    }
                }
            },

            flows: {
                async runGenerationProcess(prompt, tone, arc, useGuideImage, useGuideComplement) {
                    if (App.dom.generateBtn.disabled) return;
                    App.ui.setPageLoading(true, "Creando el guion...");
                    App.dom.pageCanvas.innerHTML = '';
                    App.dom.pageActionsWrapper.classList.add('hidden');

                    try {
                        const script = await App.api.generateScript(prompt, tone, arc);
                        App.state.lastGeneratedScript = script;

                        if (!script || !Array.isArray(script) || script.length === 0) {
                            throw new Error("La IA no devolvió un guion válido. Intenta reformular tu idea.");
                        }
                        
                        const maxAttempts = 3;
                        let panelData = script.map(panel => ({ ...panel, imageUrl: null, error: null }));
                        let failedPanelIndexes = panelData.map((_, index) => index);

                        for (let attempt = 1; attempt <= maxAttempts && failedPanelIndexes.length > 0; attempt++) {
                            App.ui.setPageLoading(true, `Generando ${failedPanelIndexes.length} imágenes (intento ${attempt}/${maxAttempts})...`);
                            
                            const promisesForFailed = failedPanelIndexes.map(index => 
                                App.api.generateImageForPanel(panelData[index].description, useGuideImage, useGuideComplement)
                            );

                            const results = await Promise.allSettled(promisesForFailed);
                            const stillFailingIndexes = [];
                            results.forEach((result, i) => {
                                const originalPanelIndex = failedPanelIndexes[i];
                                if (result.status === 'fulfilled') {
                                    panelData[originalPanelIndex].imageUrl = result.value;
                                    panelData[originalPanelIndex].error = null;
                                } else {
                                    panelData[originalPanelIndex].error = result.reason.message;
                                    stillFailingIndexes.push(originalPanelIndex);
                                }
                            });
                            failedPanelIndexes = stillFailingIndexes;
                        }

                        App.ui.setPageLoading(true, "Componiendo la página final...");
                        App.ui.renderGeneratedPage(panelData);
                        App.dom.pageActionsWrapper.classList.remove('hidden');

                    } catch (error) {
                        console.error("Error detallado en el proceso de generación:", error);
                        App.ui.showErrorModal(`Ocurrió un error en la creación: ${error.message}`);
                        App.dom.pageCanvas.innerHTML = '<div class="manga-panel flex items-center justify-center text-center text-gray-500 p-4"><p>La generación falló. Inténtalo de nuevo.</p></div>';
                    } finally {
                        App.ui.setPageLoading(false);
                    }
                },
                generateFullPage() {
                    const characters = App.dom.promptCharacters.value.trim();
                    const setting = App.dom.promptSetting.value.trim();
                    const action = App.dom.promptAction.value.trim();
                    const fullPromptText = `${characters} ${setting} ${action}`.toLowerCase();

                    if (!action) {
                        App.ui.showErrorModal("Por favor, describe la 'Acción Principal de la Página'.");
                        return;
                    }

                    const combinedPrompt = `Personajes: ${characters || 'No especificados'}. Lugar: ${setting || 'No especificado'}. Acción de la página: ${action}.`;
                    App.state.lastPrompt = combinedPrompt;
                    
                    App.state.useGuideImageForCurrentStory = App.state.guideImage && fullPromptText.includes('imagen guia');
                    App.state.useGuideComplementForCurrentStory = App.state.guideComplementImage && fullPromptText.includes('complemento guia');

                    const tone = App.dom.fullPageTone.value;
                    const arc = App.dom.fullPageArc.value;
                    this.runGenerationProcess(combinedPrompt, tone, arc, App.state.useGuideImageForCurrentStory, App.state.useGuideComplementForCurrentStory);
                },
                continueStory() {
                    if (!App.state.lastGeneratedScript || App.state.lastGeneratedScript.length === 0) {
                        App.ui.showErrorModal("Primero debes generar una página para poder continuar la historia.");
                        return;
                    }
                    
                    const lastPanel = App.state.lastGeneratedScript[App.state.lastGeneratedScript.length - 1];
                    const lastSceneSummary = `La última viñeta mostraba: ${lastPanel.description.trim()} ${lastPanel.dialogue ? `(con el diálogo: "${lastPanel.dialogue.trim()}")` : ''}`;
                    const continuationPrompt = `La historia principal es sobre: "${App.state.lastPrompt}". ${lastSceneSummary}. Continúa la historia a partir de este punto, generando las siguientes 3 o 4 viñetas.`;
                    const tone = App.dom.fullPageTone.value;
                    
                    this.runGenerationProcess(continuationPrompt, tone, "el nudo (desarrollo, punto de inflexion)", App.state.useGuideImageForCurrentStory, App.state.useGuideComplementForCurrentStory);
                },
                async addPageToStory() {
                    if (typeof html2canvas === 'undefined') {
                        App.ui.showErrorModal("Error crítico: La librería de renderizado no ha cargado. Por favor, refresca la página.");
                        return;
                    }
                    App.ui.showToast("Guardando página...");
                    try {
                        const canvas = await html2canvas(App.dom.pageCanvas, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                        const imageDataUrl = canvas.toDataURL('image/png', 1.0);
                        App.state.storyPages.push(imageDataUrl);
                        App.ui.updateStoryEditorUI();
                        App.ui.showToast("¡Página añadida a tu historia!");
                        App.ui.switchTab('story');
                    } catch (error) {
                        console.error("Error al guardar la página en la historia:", error);
                        App.ui.showErrorModal("No se pudo guardar la página como imagen.");
                    }
                }
            },
            
            handlers: {
                handleGuideImageUpload(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            App.state.guideImage = ev.target.result;
                            App.dom.guideImagePreview.src = App.state.guideImage;
                            App.dom.guideImagePreview.classList.remove('hidden');
                            App.dom.guideImagePlaceholder.classList.add('hidden');
                            App.dom.removeGuideImageBtn.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                },
                handleRemoveGuideImage(e) {
                    e.preventDefault(); e.stopPropagation();
                    App.state.guideImage = null;
                    App.dom.guideImageUpload.value = '';
                    App.dom.guideImagePreview.src = '';
                    App.dom.guideImagePreview.classList.add('hidden');
                    App.dom.guideImagePlaceholder.classList.remove('hidden');
                    App.dom.removeGuideImageBtn.classList.add('hidden');
                },
                handleGuideComplementUpload(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            App.state.guideComplementImage = ev.target.result;
                            App.dom.guideComplementPreview.src = App.state.guideComplementImage;
                            App.dom.guideComplementPreview.classList.remove('hidden');
                            App.dom.guideComplementPlaceholder.classList.add('hidden');
                            App.dom.removeGuideComplementBtn.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                },
                handleRemoveGuideComplement(e) {
                    e.preventDefault(); e.stopPropagation();
                    App.state.guideComplementImage = null;
                    App.dom.guideComplementUpload.value = '';
                    App.dom.guideComplementPreview.src = '';
                    App.dom.guideComplementPreview.classList.add('hidden');
                    App.dom.guideComplementPlaceholder.classList.remove('hidden');
                    App.dom.removeGuideComplementBtn.classList.add('hidden');
                },
                async handleStoryBoardClick(e) {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;

                    e.preventDefault();

                    const { action, index } = button.dataset;
                    
                    if (action === 'add-to-animation') {
                        const pageSrc = App.state.storyPages[index];
                        App.animation.addFrame(pageSrc);
                    } else if (action === 'download') {
                        const pageSrc = App.state.storyPages[index];
                        const link = document.createElement('a');
                        link.href = pageSrc;
                        link.download = `manga-page-${parseInt(index) + 1}.png`;
                        link.className = 'btn btn-primary';
                        link.textContent = 'Descargar Página';
                        App.ui.showDownloadModal(link);
                        
                    } else if (action === 'delete') {
                        App.state.storyPages.splice(index, 1);
                        App.render();
                        App.ui.showToast("Página eliminada.");
                    }
                }
            },
            
            animation: {
                addFrame(src) {
                    App.state.animationFrames.push(src);
                    App.ui.updateAnimationFramesUI();
                    App.ui.showToast(`Página añadida a la animación. Total: ${App.state.animationFrames.length}`);
                    App.ui.switchTab('animation');
                },
                
                playNextFrame(currentFrameIndex) {
                    const { animImg1, animImg2 } = App.dom;
                    const { activeAnimImage, animationFrames, currentTransition } = App.state;

                    const nextFrameIndex = (currentFrameIndex + 1) % animationFrames.length;
                    const nextImageSrc = animationFrames[nextFrameIndex];

                    const currentImg = activeAnimImage;
                    const nextImg = (currentImg === animImg1) ? animImg2 : animImg1;
                    
                    nextImg.src = nextImageSrc;

                    if(currentTransition === 'none') {
                        currentImg.classList.add('anim-img-hidden');
                        nextImg.classList.remove('anim-img-hidden');
                    } else if (currentTransition === 'fade') {
                        currentImg.classList.add('fade-out');
                        currentImg.classList.remove('fade-in');
                        nextImg.classList.remove('fade-out', 'anim-img-hidden');
                        nextImg.classList.add('fade-in');
                    } else if (currentTransition === 'slide') {
                        currentImg.classList.add('slide-out');
                        
                        nextImg.classList.add('slide-in-initial');
                        nextImg.classList.remove('anim-img-hidden');
                        
                        void nextImg.offsetWidth; 
                        
                        nextImg.classList.remove('slide-in-initial');
                        nextImg.classList.add('slide-in');
                    }
                    
                    App.state.activeAnimImage = nextImg;
                    return nextFrameIndex;
                },

                toggle() {
                    if (App.state.animationFrames.length < 1) return;
                    App.state.isPlaying = !App.state.isPlaying;
                    App.dom.playPauseBtn.textContent = App.state.isPlaying ? '❚❚ Pause' : '▶ Play';
                    
                    if (App.state.isPlaying) {
                        let currentFrame = App.state.animationFrames.indexOf(App.state.activeAnimImage.src);
                        if(currentFrame === -1) currentFrame = 0;

                        clearInterval(App.state.animationInterval);
                        App.state.animationInterval = setInterval(() => {
                            if (App.state.animationFrames.length === 0) {
                                this.toggle(); return;
                            }
                            currentFrame = this.playNextFrame(currentFrame);
                        }, 1000 / App.state.fps);
                    } else {
                        clearInterval(App.state.animationInterval);
                    }
                },
                setFps(value) {
                    App.state.fps = parseInt(value, 10);
                    App.dom.fpsValue.textContent = App.state.fps;
                    if (App.state.isPlaying) {
                        this.toggle(); 
                        this.toggle();
                    }
                },
                setTransition(value) {
                    App.state.currentTransition = value;
                },
                clear() {
                    if (App.state.isPlaying) this.toggle();
                    App.state.animationFrames = [];
                    App.render();
                },
                async download() {
                    if (App.state.animationFrames.length === 0) {
                        App.ui.showErrorModal("No hay frames en la animación para descargar.");
                        return;
                    }
                    if (typeof GIF === 'undefined') {
                        App.ui.showErrorModal("La librería de animación (gif.js) no se ha cargado.");
                        return;
                    }

                    App.ui.setPageLoading(true, `Preparando GIF... 0/${App.state.animationFrames.length}`);
                    
                    try {
                        const gif = new GIF({
                            workers: 2,
                            quality: 10,
                            width: 500, 
                            height: 750,
                        });

                        const imagePromises = App.state.animationFrames.map(src => {
                            return new Promise((resolve, reject) => {
                                const img = new Image();
                                img.crossOrigin = "Anonymous";
                                img.onload = () => resolve(img);
                                img.onerror = reject;
                                img.src = src;
                            });
                        });

                        const loadedImages = await Promise.all(imagePromises);
                        
                        for (let i = 0; i < loadedImages.length; i++) {
                            App.ui.setPageLoading(true, `Procesando frame ${i + 1}/${loadedImages.length}`);
                            gif.addFrame(loadedImages[i], { delay: 1000 / App.state.fps });
                        }

                        gif.on('finished', function(blob) {
                            App.ui.setPageLoading(false);
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = 'manga-studio-animation.gif';
                            link.className = 'btn btn-primary';
                            link.textContent = 'Descargar Animación GIF';
                            App.ui.showDownloadModal(link);
                        });
                        
                        gif.on('progress', function(p) {
                            App.ui.setPageLoading(true, `Renderizando GIF: ${Math.round(p * 100)}%`);
                        });
                        
                        gif.render();

                    } catch (error) {
                        console.error("Error creando el GIF:", error);
                        App.ui.showErrorModal("No se pudo crear el GIF. Puede que alguna imagen no se haya cargado correctamente.");
                        App.ui.setPageLoading(false);
                    }
                }
            }
        };

        App.init();
    });
    </script>
</body>
</html>

